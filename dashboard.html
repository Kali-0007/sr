<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard - TaxEasePro</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
  :root {
    --primary: #00ff9d;
    --secondary: #00d4ff;
    --bg-dark: #0d0d0d;
    --panel-bg: #1a1a1a;
    --text-grey: #a1a1aa;
    --border: #333;
  }

  body {
    margin: 0;
    font-family: 'Inter', sans-serif;
    background: var(--bg-dark);
    color: #fff;
    overflow-x: hidden;
  }

  /* --- 1. Top Header Bar --- */
  header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0 30px;
    background: rgba(17, 17, 17, 0.95);
    backdrop-filter: blur(10px);
    position: fixed;
    width: 100%;
    top: 0;
    z-index: 1000;
    height: 70px;
    border-bottom: 1px solid var(--border);
    box-sizing: border-box;
  }

  header .logo {
    font-size: 24px;
    font-weight: 700;
    color: var(--primary);
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .header-right {
    display: flex;
    align-items: center;
    gap: 25px;
  }

  .search-bar input {
    background: #222;
    border: 1px solid #444;
    padding: 8px 15px;
    border-radius: 20px;
    color: #fff;
    width: 250px;
    outline: none;
  }

  .user-welcome {
    font-size: 14px;
    color: var(--text-grey);
  }
  .user-welcome span {
    color: #fff;
    font-weight: 600;
  }

  .icon-btn {
    background: none;
    border: none;
    color: #fff;
    cursor: pointer;
    font-size: 20px;
    position: relative;
  }
  
  .badge {
    position: absolute;
    top: -5px;
    right: -5px;
    background: #ff4757;
    width: 8px;
    height: 8px;
    border-radius: 50%;
  }

  .logout-btn-header {
    background: #ff475720;
    color: #ff4757;
    padding: 8px 16px;
    border-radius: 6px;
    text-decoration: none;
    font-size: 14px;
    font-weight: 600;
    transition: 0.3s;
  }
  .logout-btn-header:hover { background: #ff4757; color: #fff; }

  /* --- 2. Sidebar --- */
  .container { display: flex; margin-top: 70px; min-height: calc(100vh - 70px); }

  .sidebar {
    width: 250px;
    background: var(--panel-bg);
    border-right: 1px solid var(--border);
    position: fixed;
    height: 100%;
    padding-top: 20px;
    transition: 0.3s;
    z-index: 900;
  }

  .sidebar a {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 16px 25px;
    color: var(--text-grey);
    text-decoration: none;
    font-weight: 500;
    transition: 0.2s;
    border-left: 3px solid transparent;
  }

  .sidebar a:hover, .sidebar a.active {
    background: rgba(0, 255, 157, 0.05);
    color: var(--primary);
    border-left: 3px solid var(--primary);
  }

  /* --- 3. Main Content Area --- */
  .main-content {
    margin-left: 250px;
    padding: 30px;
    flex: 1;
    width: 100%;
  }

  /* Progress Tracker */
  .progress-section {
    background: var(--panel-bg);
    padding: 25px;
    border-radius: 12px;
    margin-bottom: 30px;
    border: 1px solid var(--border);
  }
  .progress-title { font-size: 14px; color: var(--text-grey); margin-bottom: 15px; }
  
  .stepper {
    display: flex;
    justify-content: space-between;
    position: relative;
  }
  .stepper::before {
    content: '';
    position: absolute;
    top: 15px;
    left: 0;
    width: 100%;
    height: 2px;
    background: #333;
    z-index: 0;
  }
  .step {
    position: relative;
    z-index: 1;
    text-align: center;
    width: 20%;
  }
  .step-circle {
    width: 30px;
    height: 30px;
    background: #333;
    border-radius: 50%;
    margin: 0 auto 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    color: #777;
    transition: 0.3s;
  }
  .step.active .step-circle { background: var(--primary); color: #000; box-shadow: 0 0 10px var(--primary); }
  .step.completed .step-circle { background: var(--secondary); color: #000; }
  .step-label { font-size: 12px; color: #aaa; }

  /* Overview Cards */
  .overview-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
  }
  .stat-card {
    background: var(--panel-bg);
    padding: 20px;
    border-radius: 12px;
    border: 1px solid var(--border);
    position: relative;
    overflow: hidden;
  }
  .stat-card::after {
    content: '';
    position: absolute;
    top: 0; right: 0; width: 5px; height: 100%;
    background: var(--primary);
  }
  .stat-card h3 { margin: 0 0 10px; font-size: 14px; color: var(--text-grey); }
  .stat-card .value { font-size: 24px; font-weight: 700; color: #fff; }
  .stat-card .sub-text { font-size: 12px; color: var(--secondary); margin-top: 5px; }

  /* Services Section */
  .services-section { margin-bottom: 40px; }
  .section-title { font-size: 20px; font-weight: 700; margin-bottom: 20px; border-left: 4px solid var(--secondary); padding-left: 15px; }
  
  .services-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
  }
  .service-card {
    background: linear-gradient(145deg, #1a1a1a, #222);
    padding: 25px;
    border-radius: 15px;
    text-align: center;
    border: 1px solid var(--border);
    transition: 0.3s;
  }
  .service-card:hover { transform: translateY(-5px); border-color: var(--primary); }
  .service-title { font-size: 18px; font-weight: 700; color: #fff; margin-bottom: 10px; }
  .service-price { font-size: 28px; color: var(--primary); font-weight: 700; margin-bottom: 15px; }
  .service-btn {
    background: var(--primary);
    color: #000;
    border: none;
    padding: 10px 20px;
    border-radius: 8px;
    font-weight: 600;
    cursor: pointer;
    width: 100%;
  }

  /* Document Management */
  .upload-area {
    border: 2px dashed #444;
    border-radius: 12px;
    padding: 40px;
    text-align: center;
    background: rgba(255,255,255,0.02);
    cursor: pointer;
    transition: 0.3s;
  }
  .upload-area:hover { border-color: var(--secondary); }
  
  /* NEW: Upload Module Styles */
  .upload-area.highlight {
    border-color: var(--primary);
    background: rgba(0, 255, 157, 0.1);
  }
  
  #uploadProgressContainer {
    margin-top: 20px;
    display: flex;
    flex-direction: column;
    gap: 10px;
  }

  .upload-item {
    background: #222;
    padding: 12px 20px;
    border-radius: 8px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border: 1px solid #333;
  }
  
  .upload-item.success { border-color: var(--primary); }
  .upload-item.error { border-color: #ff4757; }

  .file-info { display: flex; flex-direction: column; gap: 4px; }
  .fname { font-weight: 600; font-size: 14px; color: #fff; }
  .fmsg { font-size: 12px; color: #888; }
  
  .status-icon { font-weight: bold; font-size: 18px; }
  .upload-item.success .status-icon { color: var(--primary); }
  .upload-item.error .status-icon { color: #ff4757; }

  /* Simple Spinner */
  .spinner {
    width: 16px; height: 16px;
    border: 2px solid #555;
    border-top: 2px solid var(--secondary);
    border-radius: 50%;
    animation: spin 1s linear infinite;
  }
  @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

  .doc-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 20px;
    background: var(--panel-bg);
    border-radius: 10px;
    overflow: hidden;
  }
  .doc-table th, .doc-table td { padding: 15px; text-align: left; border-bottom: 1px solid #333; }
  .doc-table th { background: #222; color: var(--text-grey); font-weight: 500; }
  .status-badge { padding: 4px 10px; border-radius: 4px; font-size: 12px; font-weight: 600; }
  .status-pending { background: #ffaa0020; color: #ffaa00; }
  .status-approved { background: #00ff9d20; color: #00ff9d; }

  /* Profile Styles (Preserved) */
  .profile-section { max-width: 700px; }
  .info-grid {
    display: grid;
    grid-template-columns: 150px 1fr;
    gap: 16px 20px;
    margin-bottom: 30px;
    background: var(--panel-bg);
    padding: 25px;
    border-radius: 12px;
  }
  .info-label { color: var(--secondary); font-weight: 600; }
  .info-value { color: white; }
  
  .action-btn {
    padding: 10px 20px;
    border-radius: 8px;
    border: none;
    font-weight: 600;
    cursor: pointer;
    margin-right: 10px;
  }
  .btn-primary { background: var(--secondary); color: #000; }
  .btn-danger { background: #ff4757; color: #fff; }

  /* Modal */
  .modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); }
  .modal-content { background: #1a1a1a; margin: 10% auto; padding: 30px; border-radius: 15px; width: 90%; max-width: 500px; border: 1px solid var(--border); }
  .modal-content input { width: 100%; padding: 12px; margin: 10px 0; border-radius: 8px; border: 1px solid #444; background: #0d0d0d; color: #fff; box-sizing: border-box;}
  
  /* Mobile Responsive */
  @media (max-width: 768px) {
    .sidebar { transform: translateX(-100%); width: 0; }
    .main-content { margin-left: 0; }
    header { padding: 0 15px; }
    .search-bar { display: none; } /* Hide search on mobile for space */
    .user-welcome span { display: none; }
  }
</style>
</head>
<body>

<header>
  <div class="logo">
    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/></svg>
    TaxEasePro
  </div>
  
  <div class="search-bar">
    <input type="text" placeholder="Search ITRs, Documents...">
  </div>

  <div class="header-right">
    <button class="icon-btn">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path><path d="M13.73 21a2 2 0 0 1-3.46 0"></path></svg>
      <div class="badge"></div>
    </button>
    <div class="user-welcome">
      Welcome, <span id="firstNameDisplay">User</span>
    </div>
    <a href="#" id="logoutLink" class="logout-btn-header">Logout</a>
  </div>
</header>

<div class="container">
  <div class="sidebar">
    <a href="#" class="active" data-tab="home">
        <span>üìä</span> Dashboard
    </a>
    <a href="#" data-tab="profile">
        <span>üë§</span> My Profile
    </a>
    <a href="#" data-tab="returns">
        <span>üìÅ</span> My ITRs / Reports
    </a>
    <a href="#" data-tab="upload">
        <span>‚òÅÔ∏è</span> Upload Documents
    </a>
    <a href="#" data-tab="services">
        <span>üõí</span> Purchase Services
    </a>
    <a href="#" data-tab="payments">
        <span>üí≥</span> Payment Status
    </a>
    <a href="#" data-tab="support">
        <span>üéß</span> Support
    </a>
  </div>

  <div class="main-content">
    
    <div id="home" class="tab-content">
      
      <div class="progress-section">
        <div class="progress-title">ITR Filing Status: <strong>Documents Uploaded</strong></div>
        <div class="stepper">
          <div class="step completed">
            <div class="step-circle">‚úì</div>
            <div class="step-label">Upload</div>
          </div>
          <div class="step active">
            <div class="step-circle">2</div>
            <div class="step-label">Review</div>
          </div>
          <div class="step">
            <div class="step-circle">3</div>
            <div class="step-label">Payment</div>
          </div>
          <div class="step">
            <div class="step-circle">4</div>
            <div class="step-label">File</div>
          </div>
          <div class="step">
            <div class="step-circle">5</div>
            <div class="step-label">Download</div>
          </div>
        </div>
      </div>

      <div class="overview-grid">
        <div class="stat-card">
          <h3>Pending Action</h3>
          <div class="value">Upload Form 16</div>
          <div class="sub-text">Due in 5 days</div>
        </div>
        <div class="stat-card" style="border-right-color: #00d4ff;">
          <h3>Tax Savings Suggestion</h3>
          <div class="value">‚Çπ12,000</div>
          <div class="sub-text">Potential saving via 80C</div>
        </div>
        <div class="stat-card" style="border-right-color: #ff4757;">
          <h3>Next Deadline</h3>
          <div class="value">31st July</div>
          <div class="sub-text">ITR Filing Last Date</div>
        </div>
      </div>

      <h2 class="section-title">Our Services</h2>
      <div class="services-grid">
        <div class="service-card">
          <div class="service-title">Basic ITR</div>
          <div class="service-price">‚Çπ499</div>
          <button class="service-btn">Buy Now</button>
        </div>
        <div class="service-card" style="border: 1px solid var(--primary);">
          <div class="service-title">Premium (Assisted)</div>
          <div class="service-price">‚Çπ999</div>
          <button class="service-btn">Buy Now</button>
        </div>
        <div class="service-card">
          <div class="service-title">Expert Consultation</div>
          <div class="service-price">‚Çπ1999</div>
          <button class="service-btn">Buy Now</button>
        </div>
      </div>

      <h2 class="section-title" style="margin-top:40px;">Recent Documents</h2>
      <table class="doc-table">
        <thead>
          <tr>
            <th>File Name</th>
            <th>Date</th>
            <th>Status</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody id="recentDocsBody">
           <tr><td colspan="4" style="text-align:center; padding:20px; color:#666;">Loading documents...</td></tr>
        </tbody>
      </table>
    </div>

    <div id="profile" class="tab-content" style="display:none;">
      <h2 class="section-title">My Profile</h2>
      <div class="profile-section" id="profileSection">
        <div class="info-grid" id="profileGrid">
           </div>
        <button class="action-btn btn-primary" id="editProfileBtn">Edit Profile</button>
        <button class="action-btn btn-danger" id="logoutBtn">Logout</button>
      </div>
      <div class="loading" id="profileLoading">Loading your profile...</div>
    </div>

    <div id="upload" class="tab-content" style="display:none;">
      <h2 class="section-title">Upload Documents</h2>
      
      <div class="upload-area" id="dropZone">
        <svg width="50" height="50" viewBox="0 0 24 24" fill="none" stroke="#555" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>
        <p style="color:#aaa; margin-top:10px;">Drag & Drop files here or click to browse</p>
        <p style="color:#666; font-size:12px;">Supports PDF, JPG, PNG (Max 15MB)</p>
        
        <input type="file" id="fileInput" multiple style="display:none" accept=".pdf,.jpg,.jpeg,.png">
        
        <button class="service-btn" id="selectFilesBtn" style="width:auto; margin-top:10px;">Select Files</button>
      </div>

      <div id="uploadProgressContainer"></div>
    </div>

    <div id="services" class="tab-content" style="display:none;">
      <h2 class="section-title">Purchase Services</h2>
      <div class="services-grid">
        <div class="service-card">
          <div class="service-title">Basic Filing</div>
          <p style="color:#999; font-size:13px;">For Salaried Individuals below 5L income.</p>
          <div class="service-price">‚Çπ499</div>
          <button class="service-btn">Buy Now</button>
        </div>
        <div class="service-card" style="border: 1px solid var(--primary);">
            <div class="service-title">Premium Filing</div>
            <p style="color:#999; font-size:13px;">Capital Gains, House Property & Multiple incomes.</p>
            <div class="service-price">‚Çπ999</div>
            <button class="service-btn">Buy Now</button>
        </div>
        <div class="service-card">
            <div class="service-title">Business / Expert</div>
            <p style="color:#999; font-size:13px;">For Business owners, GST & Audit cases.</p>
            <div class="service-price">‚Çπ1999</div>
            <button class="service-btn">Buy Now</button>
        </div>
      </div>
    </div>

    <div id="returns" class="tab-content" style="display:none;">
        <h2 class="section-title">My Filed ITRs</h2>
        <p class="user-welcome">Your filed returns will appear here.</p>
    </div>
    <div id="payments" class="tab-content" style="display:none;">
        <h2 class="section-title">Payment History</h2>
        <p class="user-welcome">No payments made yet.</p>
    </div>
    <div id="support" class="tab-content" style="display:none;">
        <h2 class="section-title">Support</h2>
        <p>Contact us at support@taxeasepro.com</p>
    </div>

  </div>
</div>

<div id="editModal" class="modal">
  <div class="modal-content">
    <h3 style="color:#fff; margin-top:0;">Edit Profile</h3>
    <input type="text" id="editUsername" placeholder="Username">
    <input type="text" id="editFirstName" placeholder="First Name">
    <input type="text" id="editSurname" placeholder="Surname">
    <input type="email" id="editEmail" placeholder="Email">
    <input type="text" id="editMobile" placeholder="Mobile">
    <input type="text" id="editCity" placeholder="City">
    <input type="text" id="editState" placeholder="State">
    <input type="text" id="editCountry" placeholder="Country">
    <input type="text" id="editPincode" placeholder="Pincode">
    <div style="display:flex; gap:10px; margin-top:15px;">
        <button id="saveProfileBtn" class="service-btn">Save Changes</button>
        <button id="closeModalBtn" class="service-btn" style="background:#333; color:#fff;">Cancel</button>
    </div>
  </div>
</div>

<script>
// --- GOOGLE SHEET CONNECTION & LOGIC (PRESERVED) ---
const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbwQSNP-7jfTMICpZfh8QC2VeGxnzdOTytndl81h5gvvm402HLvWzCvOQV2EAwvI5JKv/exec";

if (!localStorage.getItem('authToken')) {
  alert("Login first!");
  window.location.href = "login.html";
}

// Tab Navigation Logic
const tabs = document.querySelectorAll('.sidebar a');
const tabContents = document.querySelectorAll('.tab-content');
tabs.forEach(tab => {
  tab.addEventListener('click', (e)=>{
    e.preventDefault();
    // Remove active class from all tabs
    tabs.forEach(t=>t.classList.remove('active'));
    // Add active class to clicked tab
    tab.classList.add('active');
    // Hide all contents
    tabContents.forEach(tc=>tc.style.display='none');
    // Show target content
    const targetId = tab.dataset.tab;
    if(document.getElementById(targetId)) {
        document.getElementById(targetId).style.display='block';
    }
  });
});

// Load Profile Function
async function loadProfile() {
  const token = localStorage.getItem('authToken')?.trim();
  const formData = new URLSearchParams({ action: "get-profile", token: token });

  try {
    const res = await fetch(WEB_APP_URL, { method: "POST", body: formData });
    const data = await res.json();

    if(data.status === "success"){
      const p = data.profile;
      // Update Header Name
      const nameEl = document.getElementById('firstNameDisplay');
      if(nameEl) nameEl.textContent = p.firstName;
      
      // Update Profile Section
      const loadingEl = document.getElementById('profileLoading');
      const sectionEl = document.getElementById('profileSection');
      if(loadingEl) loadingEl.style.display = 'none';
      if(sectionEl) sectionEl.style.display = 'block';

      const grid = document.getElementById('profileGrid');
      if(grid) {
          grid.innerHTML = '';
          const fields = [
            ["Username", p.username],
            ["Full Name", p.firstName + " " + p.surname],
            ["Email", p.email],
            ["Mobile", p.mobile],
            ["Gender", p.gender || "‚Äî"],
            ["Address", `${p.city}, ${p.state}, ${p.country} - ${p.pincode}`],
            ["Member Since", new Date(p.createdAt).toLocaleDateString('en-IN')]
          ];
          fields.forEach(([label, value])=>{
            const l = document.createElement('div'); l.className="info-label"; l.textContent=label+":";
            const v = document.createElement('div'); v.className="info-value"; v.textContent=value;
            grid.appendChild(l); grid.appendChild(v);
          });
      }

      // Pre-fill modal inputs
      if(document.getElementById('editUsername')) document.getElementById('editUsername').value = p.username;
      if(document.getElementById('editFirstName')) document.getElementById('editFirstName').value = p.firstName;
      if(document.getElementById('editSurname')) document.getElementById('editSurname').value = p.surname;
      if(document.getElementById('editEmail')) document.getElementById('editEmail').value = p.email;
      if(document.getElementById('editMobile')) document.getElementById('editMobile').value = p.mobile;
      if(document.getElementById('editCity')) document.getElementById('editCity').value = p.city;
      if(document.getElementById('editState')) document.getElementById('editState').value = p.state;
      if(document.getElementById('editCountry')) document.getElementById('editCountry').value = p.country;
      if(document.getElementById('editPincode')) document.getElementById('editPincode').value = p.pincode;

    } else {
      alert("Session expired! Login again.");
      localStorage.clear();
      window.location.href = "login.html";
    }
  } catch(err){
    console.error(err);
    alert("Failed to load profile (Network Error)");
  }
}

// Initial Load
loadProfile();

// Logout Logic
const logoutBtn = document.getElementById('logoutBtn');
if(logoutBtn) logoutBtn.onclick = () => { localStorage.clear(); window.location.href="index.html"; }

const logoutLinkHeader = document.getElementById('logoutLink');
if(logoutLinkHeader) logoutLinkHeader.onclick = e => { e.preventDefault(); localStorage.clear(); window.location.href="index.html"; }

// Edit Profile Modal Logic
const modal = document.getElementById('editModal');
const editBtn = document.getElementById('editProfileBtn');
const closeBtn = document.getElementById('closeModalBtn');

if(editBtn) editBtn.onclick = ()=>{ modal.style.display='block'; }
if(closeBtn) closeBtn.onclick = ()=>{ modal.style.display='none'; }
window.onclick = function(event){ if(event.target == modal){ modal.style.display='none'; } }

// Save Profile Logic
const saveBtn = document.getElementById('saveProfileBtn');
if(saveBtn) {
    saveBtn.onclick = async ()=>{
      const token = localStorage.getItem('authToken');
      const formData = new URLSearchParams({
        action: "update-profile",
        token: token,
        username: document.getElementById('editUsername').value,
        firstName: document.getElementById('editFirstName').value,
        surname: document.getElementById('editSurname').value,
        email: document.getElementById('editEmail').value,
        mobile: document.getElementById('editMobile').value,
        city: document.getElementById('editCity').value,
        state: document.getElementById('editState').value,
        country: document.getElementById('editCountry').value,
        pincode: document.getElementById('editPincode').value
      });

      try{
        saveBtn.textContent = "Saving...";
        const res = await fetch(WEB_APP_URL, { method: "POST", body: formData });
        const data = await res.json();
        saveBtn.textContent = "Save Changes";
        
        if(data.status==="success"){
          alert("Profile updated successfully!");
          modal.style.display='none';
          loadProfile(); // Reload data
        } else {
          alert("Failed to update profile: " + data.message);
        }
      } catch(err){
        saveBtn.textContent = "Save Changes";
        alert("Error updating profile");
      }
    }
}
</script>

<script src="upload-handler.js"></script>

</body>
</html>
