<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Tax Computation Tool – FY 2025-26 (Accurate & Detailed)</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/3.0.3/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/5.0.2/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body {
            margin: 0;
            font-family: 'Inter', sans-serif;
            background: #000;
            color: #fff;
            line-height: 1.6;
        }
        .tool-container {
            max-width: 950px;
            margin: 40px auto;
            background: #111;
            border-radius: 16px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
            overflow: hidden;
        }
        .tool-header {
            background: linear-gradient(135deg, #4a90e2, #357abd);
            padding: 32px;
            text-align: center;
            position: relative;
        }
        .tool-header i { font-size: 48px; margin-bottom: 12px; display: block; }
        .step-indicator {
            display: flex;
            justify-content: center;
            margin: 20px 0;
            background: #222;
        }
        .step {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: #333;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 12px;
            font-weight: 600;
            color: #fff;
            transition: background 0.3s;
        }
        .step.active { background: #4a90e2; }
        .step.completed { background: #28a745; }
        .tool-form {
            padding: 30px;
        }
        .form-step {
            display: none;
        }
        .form-step.active { display: block; }
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
        }
        label { font-weight: 600; margin-bottom: 6px; display: block; color: #ccc; }
        input, select {
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid #444;
            background: #222;
            color: #fff;
            box-sizing: border-box;
            transition: border 0.3s;
        }
        input:focus, select:focus { border-color: #4a90e2; outline: none; }
        input::placeholder { color: #888; }
        .btn-group {
            display: flex;
            gap: 12px;
            margin-top: 24px;
            justify-content: center;
        }
        button {
            padding: 14px 24px;
            border-radius: 8px;
            border: none;
            font-size: 16px;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.3s;
        }
        .btn-primary { background: #4a90e2; color: #fff; }
        .btn-primary:hover { background: #357abd; }
        .btn-secondary { background: #555; color: #fff; }
        .btn-secondary:hover { background: #666; }
        .reset-btn { background: #dc3545; color: #fff; width: auto; }
        .download-btns {
            display: flex;
            gap: 12px;
            justify-content: center;
            margin-top: 24px;
        }
        .download-btn { padding: 12px 20px; background: #28a745; color: #fff; }
        .download-btn:hover { background: #218838; }
        .computation-results {
            padding: 30px;
            display: none;
            background: #111;
            border-top: 1px solid #333;
        }
        .results-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: #222;
        }
        .results-table th, .results-table td {
            padding: 14px;
            border-bottom: 1px solid #444;
            text-align: left;
        }
        .results-table th { background: #4a90e2; color: #fff; }
        .highlight-tax {
            color: #28a745;
            font-weight: bold;
            font-size: 18px;
        }
        .slab-breakdown {
            margin-top: 10px;
            font-size: 14px;
            color: #ccc;
            background: #333;
            padding: 8px;
            border-radius: 4px;
        }
        small { color: #888; font-size: 12px; }
        @media (max-width: 600px) {
            .form-grid { grid-template-columns: 1fr; }
            .btn-group, .download-btns { flex-direction: column; }
        }
        .close-calculator {
            position: absolute;
            top: 18px;
            right: 22px;
            background: rgba(0,0,0,0.4);
            border: none;
            color: #fff;
            font-size: 22px;
            font-weight: 600;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            cursor: pointer;
            transition: background 0.3s, transform 0.2s;
        }
        .close-calculator:hover {
            background: #dc3545;
            transform: scale(1.1);
        }
    </style>
</head>
<body>
    <div class="tool-container">
        <header class="tool-header">
            <i class="fas fa-calculator"></i>
            <h1>Advanced Tax Computation Tool</h1>
            <div>Pro Tax, Zero Stress</div>
            <button class="close-calculator">✕</button>
        </header>
        <div class="step-indicator" id="stepIndicator">
            <div class="step active" data-step="1">1</div>
            <div class="step" data-step="2">2</div>
            <div class="step" data-step="3">3</div>
            <div class="step" data-step="4">4</div>
            <div class="step" data-step="5">5</div>
        </div>
        <form id="taxForm" class="tool-form">
            <div class="form-step active" data-step="1">
                <h3><i class="fas fa-user"></i> Step 1: Tax Profile</h3>
                <div class="form-grid">
                    <div>
                        <label>Your Name (Optional)</label>
                        <input type="text" id="userName" placeholder="e.g., John Doe">
                    </div>
                    <div>
                        <label>Select Your Category <span style="color:#ff6b6b;">(Required)</span></label>
                        <select id="userCategory" required>
                            <option value="">Please select</option>
                            <option value="salaried">Salaried Employee</option>
                            <option value="business">Business Owner / Proprietor</option>
                            <option value="freelancer">Freelancer / Professional (CA, Doctor, Lawyer, Consultant etc.)</option>
                            <option value="investor">Investor / Rental Income Only</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div>
                        <label>Age Category</label>
                        <select id="ageGroup">
                            <option value="under60">Below 60 years</option>
                            <option value="senior">60-79 years (Senior)</option>
                            <option value="superSenior">80+ years (Super Senior)</option>
                        </select>
                    </div>
                    <div>
                        <label>Residency</label>
                        <select id="residentialStatus">
                            <option value="resident">Resident Indian</option>
                            <option value="nri">Non-Resident Indian</option>
                        </select>
                    </div>
                    <div style="grid-column: 1 / -1;">
                        <label>Annual Salary (pre-exemptions, ₹)</label>
                        <input type="text" id="totalSalary" value="0" placeholder="e.g., 1000000" oninput="formatNumber(this)">
                        <small>Basic pay + allowances</small>
                    </div>
                    <div>
                        <label>HRA Relief (₹)</label>
                        <input type="text" id="hraExemption" value="0" oninput="formatNumber(this)">
                    </div>
                    <div>
                        <label>Additional Exemptions (₹)</label>
                        <input type="text" id="otherExemptions" value="0" oninput="formatNumber(this)">
                    </div>
                </div>
                <div class="btn-group">
                    <button type="button" class="btn-secondary">Next</button>
                </div>
            </div>
            <div class="form-step" data-step="2">
                <h3><i class="fas fa-chart-line"></i> Step 2: Income Streams</h3>
                <div class="form-grid">
                    <div>
                        <label>Other Earnings (₹)</label>
                        <input type="text" id="otherIncome" value="0" oninput="formatNumber(this)">
                    </div>
                    <div>
                        <label>Rent Received (Gross, ₹)</label>
                        <input type="text" id="rentalIncome" value="0" oninput="formatNumber(this)">
                    </div>
                    <div>
                        <label>Municipal Taxes Paid (₹)</label>
                        <input type="text" id="municipalTaxes" value="0" oninput="formatNumber(this)">
                    </div>
                    <div>
                        <label>Property Loan Interest - Let Out (₹)</label>
                        <input type="text" id="homeLoanLetOut" value="0" oninput="formatNumber(this)">
                    </div>
                    <div>
                        <label>Property Loan Interest - Self Occupied (max ₹2L, ₹)</label>
                        <input type="text" id="homeLoanSelf" value="0" oninput="formatNumber(this)">
                    </div>
                    <div>
                        <label>Business Earnings (₹)</label>
                        <input type="text" id="businessIncome" value="0" oninput="formatNumber(this)">
                    </div>
                    <div>
                        <label>Short-Term Capital Gains u/s 111A (Equity STT, ₹)</label>
                        <input type="text" id="stcg111A" value="0" oninput="formatNumber(this)">
                    </div>
                    <div>
                        <label>Long-Term Capital Gains u/s 112A (Equity LTCG, ₹)</label>
                        <input type="text" id="ltcg112A" value="0" oninput="formatNumber(this)">
                    </div>
                    <div>
                        <label>Long-Term Capital Gains u/s 112 (Other LTCG, ₹)</label>
                        <input type="text" id="ltcg112" value="0" oninput="formatNumber(this)">
                    </div>
                    <div>
                        <label>Special Rate Incomes (Lottery, Crypto, etc., ₹)</label>
                        <input type="text" id="specialIncome" value="0" oninput="formatNumber(this)">
                    </div>
                    <div>
                        <label>Agricultural Income (₹, optional)</label>
                        <input type="text" id="agriIncome" value="0" oninput="formatNumber(this)">
                    </div>
                </div>
                <div class="btn-group">
                    <button type="button" class="btn-secondary">Previous</button>
                    <button type="button" class="btn-primary">Next</button>
                </div>
            </div>
            <div class="form-step" data-step="3">
                <h3><i class="fas fa-shield-alt"></i> Step 3: Allowable Deductions (Traditional Regime)</h3>
                <p style="color: #ccc;">New regime limits to standard deduction only.</p>
                <div class="form-grid">
                    <div>
                        <label>80C Investments (max ₹1.5L, ₹)</label>
                        <input type="text" id="section80C" value="0" oninput="formatNumber(this)">
                    </div>
                    <div>
                        <label>80D Insurance (₹)</label>
                        <input type="text" id="section80D" value="0" oninput="formatNumber(this)">
                    </div>
                    <div>
                        <label>80G Contributions (₹)</label>
                        <input type="text" id="section80G" value="0" oninput="formatNumber(this)">
                    </div>
                    <div>
                        <label>80E Loan Interest (₹)</label>
                        <input type="text" id="section80E" value="0" oninput="formatNumber(this)">
                    </div>
                    <div>
                        <label>80TTA Savings (max ₹10K, ₹)</label>
                        <input type="text" id="section80TTA" value="0" oninput="formatNumber(this)">
                    </div>
                    <div style="grid-column: 1 / -1;">
                        <label>Further Deductions (₹)</label>
                        <input type="text" id="otherDeductions" value="0" oninput="formatNumber(this)">
                    </div>
                </div>
                <div class="btn-group">
                    <button type="button" class="btn-secondary">Previous</button>
                    <button type="button" class="btn-primary">Next</button>
                </div>
            </div>
            <div class="form-step" data-step="4">
                <h3><i class="fas fa-money-check"></i> Step 4: Taxes Already Paid</h3>
                <div class="form-grid">
                    <div>
                        <label>TDS Deducted (₹)</label>
                        <input type="text" id="tds" value="0" oninput="formatNumber(this)">
                    </div>
                    <div>
                        <label>Advance Tax Paid (₹)</label>
                        <input type="text" id="advanceTax" value="0" oninput="formatNumber(this)">
                    </div>
                    <div>
                        <label>Self-Assessment Tax Paid (₹)</label>
                        <input type="text" id="selfAssessmentTax" value="0" oninput="formatNumber(this)">
                    </div>
                </div>
                <div class="btn-group">
                    <button type="button" class="btn-secondary">Previous</button>
                    <button type="button" id="generateBtn" class="btn-primary">Generate Report</button>
                </div>
            </div>
        </form>
        <div id="results" class="computation-results">
            <h2><i class="fas fa-file-invoice"></i> Computation Summary</h2>
            <p style="color: #ccc; text-align: center;">For Individuals only. Special incomes approximate. Consult CA for complex cases/Losses/Foreign income.</p>
            <div id="summaryResults" style="text-align: center; margin-bottom: 20px;"></div>
            <table class="results-table" style="display: none;">
                <thead>
                    <tr>
                        <th>Component</th>
                        <th>Traditional Regime</th>
                        <th>New Regime</th>
                    </tr>
                </thead>
                <tbody id="resultsTable">
                </tbody>
            </table>
            <div class="download-btns">
                <button class="download-btn"><i class="fas fa-file-pdf"></i> Download as PDF</button>
                <button class="download-btn"><i class="fas fa-file-excel"></i> Download as Excel</button>
            </div>
            <button type="button" class="reset-btn" style="margin-top: 20px; display: block; margin-left: auto; margin-right: auto;">New Computation</button>
        </div>
    </div>
    <script>
    function formatNumber(input) {
        let value = input.value.replace(/,/g, '');
        if (!isNaN(value) && value !== '') {
            let num = parseFloat(value);
            input.value = new Intl.NumberFormat('en-IN').format(num);
        }
    }
    function parseFormatted(value) {
        return Number(value.replace(/,/g, '')) || 0;
    }
    function formatINR(n) {
        const amount = Math.round(Number(n) || 0);
        if (amount === 0) return '0';
        return 'Rs. ' + new Intl.NumberFormat('en-IN', { maximumFractionDigits: 0 }).format(amount);
    }
    function updateSteps(currentStep) {
        document.querySelectorAll('.step').forEach((step, index) => {
            step.classList.remove('active', 'completed');
            if (index < currentStep - 1) step.classList.add('completed');
            if (index === currentStep - 1) step.classList.add('active');
        });
        document.querySelectorAll('.form-step').forEach((s, i) => {
            s.classList.toggle('active', i === currentStep - 1);
        });
    }
    function nextStep(step) { updateSteps(step); }
    function prevStep(step) { updateSteps(step); }
    function closeCalculator() {
    resetForm();                     // optional
    window.location.href = "index.html";  
}
    function resetForm() {
        document.getElementById('taxForm').reset();
        document.getElementById('results').style.display = 'none';
        updateSteps(1);
        delete window.taxData;
    }
    function calculateTax(regime, ageGroup, isResident, grossNormal, deductions, stcg111A, ltcg112A, ltcg112, specialIncome, agriIncome) {
        let stdDeduction = regime === 'old' ? 50000 : 75000;
        let normalDeductions = regime === 'old' ? deductions : 0;
        let taxableNormal = Math.max(0, grossNormal - normalDeductions - stdDeduction);
        let taxableNormalForRate = taxableNormal;
        let agri = Number(agriIncome);
        if (agri > 5000) {
            taxableNormalForRate += agri;
        }
        let exemptionLimit = 0;
        if (regime === 'old') {
            exemptionLimit = isResident ? (ageGroup === 'under60' || !isResident ? 250000 : ageGroup === 'senior' ? 300000 : 500000) : 250000;
        } else {
            exemptionLimit = 400000;
        }
        let normalTax = 0;
        let slabs = [];
        if (regime === 'new') {
            normalTax = calculateSlabTax(taxableNormalForRate, [
                {min: 400000, max: 800000, rate: 0.05},
                {min: 800000, max: 1200000, rate: 0.10},
                {min: 1200000, max: 1600000, rate: 0.15},
                {min: 1600000, max: 2000000, rate: 0.20},
                {min: 2000000, max: 2400000, rate: 0.25},
                {min: 2400000, max: Infinity, rate: 0.30}
            ], slabs, exemptionLimit);
        } else {
            normalTax = calculateSlabTax(taxableNormalForRate, [
                {min: exemptionLimit, max: 500000, rate: 0.05},
                {min: 500000, max: 1000000, rate: 0.20},
                {min: 1000000, max: Infinity, rate: 0.30}
            ], slabs, exemptionLimit);
        }
        if (agri > 5000) {
            let agriTax = calculateSlabTax(exemptionLimit + agri, regime === 'new' ? [
                {min: 400000, max: 800000, rate: 0.05},
                {min: 800000, max: 1200000, rate: 0.10},
                {min: 1200000, max: 1600000, rate: 0.15},
                {min: 1600000, max: 2000000, rate: 0.20},
                {min: 2000000, max: 2400000, rate: 0.25},
                {min: 2400000, max: Infinity, rate: 0.30}
            ] : [
                {min: exemptionLimit, max: 500000, rate: 0.05},
                {min: 500000, max: 1000000, rate: 0.20},
                {min: 1000000, max: Infinity, rate: 0.30}
            ], [], exemptionLimit);
            normalTax -= agriTax;
        }
        let preRebateNormalTax = Math.round(normalTax);
        let rebate = 0;
        let rebateLimit = regime === 'old' ? 500000 : 1200000;
        let rebateMax = regime === 'old' ? 12500 : 60000;
        if (isResident && taxableNormal <= rebateLimit) {
            rebate = Math.min(preRebateNormalTax, rebateMax);
        }
        normalTax = Math.max(0, preRebateNormalTax - rebate);
        let stcgTax = Math.round(stcg111A * 0.20);
        let ltcg112ATax = Math.round(Math.max(0, ltcg112A - 125000) * 0.125);
        let ltcg112Tax = Math.round(ltcg112 * 0.125);
        let specialTax = Math.round(specialIncome * 0.30);
        let totalSpecialTax = stcgTax + ltcg112ATax + ltcg112Tax + specialTax;
        let taxBeforeSurcharge = normalTax + totalSpecialTax;
        let totalTaxable = taxableNormal + stcg111A + Math.max(0, ltcg112A - 125000) + ltcg112 + specialIncome;
        let surcharge = calculateSurcharge(taxBeforeSurcharge, totalTaxable, regime);
        let taxWithSurcharge = taxBeforeSurcharge + surcharge;
        let marginalRelief = calculateMarginalRelief(taxBeforeSurcharge, surcharge, totalTaxable, regime);
        surcharge -= marginalRelief;
        let taxBeforeCess = taxBeforeSurcharge + surcharge;
        let cess = Math.round(taxBeforeCess * 0.04);
        let finalTax = taxBeforeCess + cess;
        return {
            tax: Math.round(finalTax),
            preRebateTax: preRebateNormalTax,
            rebateAmount: rebate,
            slabs: slabs.join(', '),
            stdDeduction,
            taxableIncome: totalTaxable,
            surcharge: surcharge,
            cess: cess,
            taxBeforeCess: taxBeforeCess,
            taxAfterRebate: normalTax + totalSpecialTax,
            normalTax: normalTax,
            stcgTax: stcgTax,
            ltcg112ATax: ltcg112ATax,
            ltcg112Tax: ltcg112Tax,
            specialTax: specialTax,
            marginalRelief: marginalRelief
        };
    }
    function calculateSlabTax(income, slabRates, slabs, exemption) {
        let tax = 0;
        let prevMax = exemption;
        for (let slab of slabRates) {
            if (income > prevMax) {
                let amount = Math.min(income, slab.max) - prevMax;
                tax += amount * slab.rate;
                slabs.push(`${slab.rate * 100}% on Rs. ${(prevMax / 100000).toFixed(1)}L - Rs. ${(slab.max / 100000).toFixed(1)}L`);
            }
            prevMax = slab.max;
            if (income <= slab.max) break;
        }
        return tax;
    }
    function calculateSurcharge(tax, income, regime) {
        let rate = 0;
        if (income > 5000000 && income <= 10000000) rate = 0.10;
        else if (income <= 20000000) rate = 0.15;
        else if (income <= 50000000) rate = 0.25;
        else if (income > 50000000) rate = regime === 'new' ? 0.25 : 0.37;
        return Math.round(tax * rate);
    }
    function calculateMarginalRelief(taxBeforeSurcharge, surcharge, income, regime) {
        let relief = 0;
        const thresholds = [5000000, 10000000, 20000000, 50000000];
        for (let threshold of thresholds) {
            if (income > threshold) {
                let taxAtThreshold = calculateTaxAtThreshold(threshold, regime, taxBeforeSurcharge / (income - threshold + taxBeforeSurcharge) * (income - threshold)); // approximate
                let surchargeAtThreshold = calculateSurcharge(taxAtThreshold, threshold, regime);
                let totalAtThreshold = taxAtThreshold + surchargeAtThreshold;
                let excess = (taxBeforeSurcharge + surcharge) - totalAtThreshold;
                if (excess > (income - threshold)) {
                    relief += excess - (income - threshold);
                }
            }
        }
        return relief;
    }
    function calculateTaxAtThreshold(threshold, regime, proportion) {
        // Simplified, assume same proportion
        return proportion;
    }
    document.addEventListener('DOMContentLoaded', function() {
        updateSteps(1);
        document.querySelector('.close-calculator').addEventListener('click', closeCalculator);
        document.querySelector('.reset-btn').addEventListener('click', resetForm);
        document.querySelector('.download-btns .download-btn:nth-child(1)').addEventListener('click', downloadPDF);
        document.querySelector('.download-btns .download-btn:nth-child(2)').addEventListener('click', downloadExcel);
        document.querySelectorAll('.form-step .btn-group').forEach(group => {
            const buttons = group.querySelectorAll('button[type="button"]');
            const currentStepEl = group.closest('.form-step');
            const currentStep = parseInt(currentStepEl.dataset.step);
            if (buttons.length === 1) {
                // Step 1: only next
                buttons[0].addEventListener('click', () => nextStep(2));
            } else {
                // Previous
                buttons[0].addEventListener('click', () => prevStep(currentStep - 1));
                // Next, if not generate
                if (buttons[1].id !== 'generateBtn') {
                    buttons[1].addEventListener('click', () => nextStep(currentStep + 1));
                }
            }
        });
        document.getElementById('generateBtn').addEventListener('click', function(e) {
            e.preventDefault();
            const userName = document.getElementById('userName').value.trim() || 'User';
            const userCategory = document.getElementById('userCategory').value;
            if (!userCategory) {
                alert('Please select your category.');
                return;
            }
            const ageGroup = document.getElementById('ageGroup').value;
            const residentialStatus = document.getElementById('residentialStatus').value;
            const isResident = residentialStatus === 'resident';
            const basicSalary = parseFormatted(document.getElementById('totalSalary').value);
            const otherIncome = parseFormatted(document.getElementById('otherIncome').value);
            const rentalIncome = parseFormatted(document.getElementById('rentalIncome').value);
            const municipalTaxes = parseFormatted(document.getElementById('municipalTaxes').value);
            const homeLoanLetOut = parseFormatted(document.getElementById('homeLoanLetOut').value);
            const hraExemption = parseFormatted(document.getElementById('hraExemption').value);
            const otherExemptions = parseFormatted(document.getElementById('otherExemptions').value);
            let section80C = parseFormatted(document.getElementById('section80C').value);
            section80C = Math.min(section80C, 150000);
            let section80D = parseFormatted(document.getElementById('section80D').value);
            const max80D = ageGroup === 'under60' ? 25000 : 50000;
            section80D = Math.min(section80D, max80D);
            const section80G = parseFormatted(document.getElementById('section80G').value);
            const section80E = parseFormatted(document.getElementById('section80E').value);
            let section80TTA = parseFormatted(document.getElementById('section80TTA').value);
            section80TTA = Math.min(section80TTA, 10000);
            let homeLoanSelf = parseFormatted(document.getElementById('homeLoanSelf').value);
            homeLoanSelf = Math.min(homeLoanSelf, 200000);
            const furtherDeductions = parseFormatted(document.getElementById('otherDeductions').value);
            const businessIncome = parseFormatted(document.getElementById('businessIncome').value);
            const stcg111A = parseFormatted(document.getElementById('stcg111A').value);
            const ltcg112A = parseFormatted(document.getElementById('ltcg112A').value);
            const ltcg112 = parseFormatted(document.getElementById('ltcg112').value);
            const specialIncome = parseFormatted(document.getElementById('specialIncome').value);
            const agriIncome = parseFormatted(document.getElementById('agriIncome').value);
            const tds = parseFormatted(document.getElementById('tds').value);
            const advanceTax = parseFormatted(document.getElementById('advanceTax').value);
            const selfAssessmentTax = parseFormatted(document.getElementById('selfAssessmentTax').value);
            const prepaidTax = tds + advanceTax + selfAssessmentTax;
            const netRentalLetOut = rentalIncome - municipalTaxes - 0.3 * (rentalIncome - municipalTaxes) - homeLoanLetOut;
            const grossNormal = basicSalary + businessIncome + otherIncome + netRentalLetOut - homeLoanSelf;
            const oldRegimeDeductions = section80C + section80D + section80G + section80E + section80TTA + hraExemption + otherExemptions + furtherDeductions;
            let oldResult = calculateTax('old', ageGroup, isResident, grossNormal, oldRegimeDeductions, stcg111A, ltcg112A, ltcg112, specialIncome, agriIncome);
            let newResult = calculateTax('new', ageGroup, isResident, grossNormal, 0, stcg111A, ltcg112A, ltcg112, specialIncome, agriIncome);
            let oldNetPayable = oldResult.tax - prepaidTax;
            let newNetPayable = newResult.tax - prepaidTax;
            const regimeAdvantage = oldNetPayable - newNetPayable;
            const recommendedRegime = oldNetPayable > newNetPayable ? 'New' : 'Traditional';
            const savings = Math.abs(regimeAdvantage);
            window.taxData = {
                timestamp: new Date().toLocaleString('en-IN'),
                userName: userName,
                userCategory: userCategory,
                basicSalary,
                businessIncome,
                otherIncome,
                rentalIncome,
                municipalTaxes,
                homeLoanLetOut,
                netRentalLetOut,
                homeLoanSelf,
                stcg111A,
                ltcg112A,
                ltcg112,
                specialIncome,
                agriIncome,
                hraExemption,
                otherExemptions,
                section80C,
                section80D,
                section80G,
                section80E,
                section80TTA,
                furtherDeductions,
                grossNormal,
                deductions: oldRegimeDeductions,
                oldStd: oldResult.stdDeduction,
                newStd: newResult.stdDeduction,
                oldTaxableNormal: Math.max(0, grossNormal - oldRegimeDeductions - oldResult.stdDeduction),
                newTaxableNormal: Math.max(0, grossNormal - newResult.stdDeduction),
                oldPreRebate: oldResult.preRebateTax,
                newPreRebate: newResult.preRebateTax,
                oldRebate: oldResult.rebateAmount,
                newRebate: newResult.rebateAmount,
                oldNormalTax: oldResult.normalTax,
                newNormalTax: newResult.normalTax,
                oldStcgTax: oldResult.stcgTax,
                newStcgTax: newResult.stcgTax,
                oldLtcg112ATax: oldResult.ltcg112ATax,
                newLtcg112ATax: newResult.ltcg112ATax,
                oldLtcg112Tax: oldResult.ltcg112Tax,
                newLtcg112Tax: newResult.ltcg112Tax,
                oldSpecialTax: oldResult.specialTax,
                newSpecialTax: newResult.specialTax,
                oldSurcharge: oldResult.surcharge,
                newSurcharge: newResult.surcharge,
                oldMarginalRelief: oldResult.marginalRelief,
                newMarginalRelief: newResult.marginalRelief,
                oldTaxBeforeCess: oldResult.taxBeforeCess,
                newTaxBeforeCess: newResult.taxBeforeCess,
                oldCess: oldResult.cess,
                newCess: newResult.cess,
                oldTax: oldResult.tax,
                newTax: newResult.tax,
                prepaidTax,
                oldNetPayable,
                newNetPayable,
                savings,
                recommendedRegime,
                oldSlabs: oldResult.slabs,
                newSlabs: newResult.slabs
            };
            document.getElementById('summaryResults').innerHTML = `
                <h3>Final Tax Payable</h3>
                <table style="margin: auto; border: 1px solid #444; background: #222;">
                    <tr><th>Regime</th><th>Tax Payable</th></tr>
                    <tr><td>Traditional</td><td>${formatINR(oldResult.tax)}</td></tr>
                    <tr><td>New</td><td>${formatINR(newResult.tax)}</td></tr>
                </table>
                <p style="text-align:center; color:#4a90e2; font-size:18px; margin-top:25px; font-weight:600;">
                    For complete and detailed computation, please download the PDF.
                </p>
            `;
            document.getElementById('results').style.display = 'block';
            updateSteps(5);
        });
    });
    function downloadPDF() {
let rendered = false; // ← Yeh line add karo (sirf yeh chahiye)
        if (typeof window.taxData === 'undefined') {
            alert('Please calculate tax first.');
            return;
        }
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF('p', 'mm', 'a4');
        const g = window.taxData;
   
        // Header
        doc.setFillColor(0, 51, 102);
        doc.rect(0, 0, 210, 40, 'F');
        const logo = new Image();
        logo.src = 'logo.png';
        let logoLoaded = false;
        logo.onload = function () {
            doc.addImage(logo, 'PNG', 10, 5, 25, 25);
            logoLoaded = true;
            renderContent();
        };
        logo.onerror = function () {
            logoLoaded = false;
            renderContent();
        };
        setTimeout(() => {
            if (!logoLoaded) renderContent();
        }, 1000);
        function renderContent() {
if (rendered) return; // ← Double call rokne ke liye
rendered = true;      // ← Ek baar chalne ke baad flag set
            const xOffset = logoLoaded ? 45 : 10;
            doc.setTextColor(255, 255, 255);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(20);
            doc.text('TaxEasePro', xOffset, 18);
            doc.setFontSize(11);
            doc.text('Advanced Tax Computation Report (FY 2025-26)', xOffset, 26);
            doc.setFontSize(9);
            doc.text('Email: support@taxeasepro.com', xOffset, 34);
            doc.text('WhatsApp: +91 98765 43210', xOffset + 60, 34);
            // Main content
            doc.setTextColor(0);
            let y = 45;
            doc.setFontSize(14);
            doc.setTextColor(0, 51, 102);
            doc.text(`Hello ${g.userName}! Here is your Detailed Tax Computation`, 15, y);
            y += 12;
            const recommended = g.recommendedRegime;
            const advantage = g.savings;
            const recommendedNet = recommended === 'New' ? g.newNetPayable : g.oldNetPayable;
            const tableData = [
                ['Component', 'Traditional Regime (Rs.)', 'New Regime (Rs.)'],
                ['Income Heads'],
                ['Basic Salary', formatINR(g.basicSalary), formatINR(g.basicSalary)],
                ['Business Income', formatINR(g.businessIncome), formatINR(g.businessIncome)],
                ['Other Income', formatINR(g.otherIncome), formatINR(g.otherIncome)],
                ['Gross Rental Income', formatINR(g.rentalIncome), formatINR(g.rentalIncome)],
                ['Less: Municipal Taxes', formatINR(g.municipalTaxes), formatINR(g.municipalTaxes)],
                ['Less: 30% Std Ded on Rental', formatINR(0.3 * (g.rentalIncome - g.municipalTaxes)), formatINR(0.3 * (g.rentalIncome - g.municipalTaxes))],
                ['Less: Interest Let Out', formatINR(g.homeLoanLetOut), formatINR(g.homeLoanLetOut)],
                ['Net Rental Income', formatINR(g.netRentalLetOut), formatINR(g.netRentalLetOut)],
                ['Less: Self Occupied Interest', formatINR(g.homeLoanSelf), formatINR(g.homeLoanSelf)],
                ['STCG u/s 111A', formatINR(g.stcg111A), formatINR(g.stcg111A)],
                ['LTCG u/s 112A', formatINR(g.ltcg112A), formatINR(g.ltcg112A)],
                ['LTCG u/s 112', formatINR(g.ltcg112), formatINR(g.ltcg112)],
                ['Special Rate Income', formatINR(g.specialIncome), formatINR(g.specialIncome)],
                ['Agricultural Income (Exempt)', formatINR(g.agriIncome), formatINR(g.agriIncome)],
                ['Gross Total Income', formatINR(g.grossNormal + g.stcg111A + g.ltcg112A + g.ltcg112 + g.specialIncome + g.agriIncome), formatINR(g.grossNormal + g.stcg111A + g.ltcg112A + g.ltcg112 + g.specialIncome + g.agriIncome)],
                [''],
                ['Deductions'],
                ['HRA Relief', formatINR(g.hraExemption), '0'],
                ['Additional Exemptions', formatINR(g.otherExemptions), '0'],
                ['Section 80C Investments', formatINR(g.section80C), '0'],
                ['Section 80D Insurance', formatINR(g.section80D), '0'],
                ['Other Deductions (80G, 80E, 80TTA, etc.)', formatINR(g.section80G + g.section80E + g.section80TTA + g.furtherDeductions), '0'],
                ['Total Deductions (excl. Std. Ded.)', formatINR(g.deductions), '0'],
                ['Less: Standard Deduction', formatINR(g.oldStd), formatINR(g.newStd)],
                [''],
                ['Taxable Normal Income', formatINR(g.oldTaxableNormal), formatINR(g.newTaxableNormal)],
                [''],
                ['Tax Computation'],
                ['Tax on Normal at Slabs', formatINR(g.oldPreRebate), formatINR(g.newPreRebate)],
                ['Less: Section 87A Rebate', formatINR(g.oldRebate), formatINR(g.newRebate)],
                ['Tax on Normal After Rebate', formatINR(g.oldNormalTax), formatINR(g.newNormalTax)],
                ['STCG Tax (u/s 111A @20%)', formatINR(g.oldStcgTax), formatINR(g.newStcgTax)],
                ['LTCG Tax (u/s 112A @12.5% >1.25L)', formatINR(g.oldLtcg112ATax), formatINR(g.newLtcg112ATax)],
                ['LTCG Tax (u/s 112 @12.5%)', formatINR(g.oldLtcg112Tax), formatINR(g.newLtcg112Tax)],
                ['Special Income Tax (@30%)', formatINR(g.oldSpecialTax), formatINR(g.newSpecialTax)],
                ['Add: Surcharge', formatINR(g.oldSurcharge), formatINR(g.newSurcharge)],
                ['Less: Marginal Relief', formatINR(g.oldMarginalRelief), formatINR(g.newMarginalRelief)],
                ['Tax Before Cess', formatINR(g.oldTaxBeforeCess), formatINR(g.newTaxBeforeCess)],
                ['Add: 4% Health & Education Cess', formatINR(g.oldCess), formatINR(g.newCess)],
                ['Net Tax Liability', formatINR(g.oldTax), formatINR(g.newTax)],
                [''],
                ['Payments'],
                ['Taxes Already Paid (TDS + Advance + Self)', formatINR(g.prepaidTax), formatINR(g.prepaidTax)],
                ['Net Tax Payable (if positive)', formatINR(Math.max(0, g.oldNetPayable)), formatINR(Math.max(0, g.newNetPayable))],
                ['Refund Amount (if negative)', formatINR(Math.max(0, -g.oldNetPayable)), formatINR(Math.max(0, -g.newNetPayable))],
                [''],
                ['Recommendation', recommended, `Savings: Rs. ${formatINR(advantage)}`]
            ];
            doc.autoTable({
                startY: y,
                head: [tableData[0]],
                body: tableData.slice(1),
                theme: 'grid',
                rowPageBreak: 'avoid',
                styles: {
                    fontSize: 7,
                    cellPadding: 3,
                    overflow: 'linebreak',
                    halign: 'left',
                    valign: 'middle'
                },
                headStyles: {
                    fillColor: [0, 51, 102],
                    textColor: [255,255,255],
                    fontSize: 9
                },
                columnStyles: {
                    0: { cellWidth: 52 },
                    1: { cellWidth: 68 },
                    2: { cellWidth: 68 }
                },
                margin: { left: 12, right: 12, top: y },
                didParseCell: function(data) {
                    if (data.row.raw && (data.row.raw[0] === 'Net Tax Liability' || data.row.raw[0] === 'Net Tax Payable (if positive)' || data.row.raw[0] === 'Refund Amount (if negative)' || data.row.raw[0] === 'Recommendation')) {
                        data.cell.styles.fontStyle = 'bold';
                        data.cell.styles.fontSize = 9;
                    } else if (data.row.raw && ['Income Heads', 'Deductions', 'Tax Computation', 'Payments'].includes(data.row.raw[0])) {
                        data.cell.styles.fillColor = [200, 200, 200];
                        data.cell.styles.textColor = [0, 0, 0];
                        data.cell.styles.fontStyle = 'bold';
                    }
                }
            });
            y = doc.lastAutoTable.finalY + 12;
            // Bottom section with proper margins
            if (y > 250) {
                doc.addPage();
                y = 20;
            }
            doc.setFillColor(240, 240, 240);
            doc.rect(5, y - 3, 200, 270 - y + 5, 'F');
            doc.setFontSize(12);
            doc.setTextColor(40, 167, 69);
            doc.text("Your Personalized Tax Saving Tips", 105, y, { align: 'center' });
            y += 10;
            doc.setFontSize(10);
            doc.setTextColor(0);
            let summaryLine = "";
            let tip1 = "";
            let tip2 = "";
            let tip3 = "";
            const category = g.userCategory;
            if (recommendedNet <= 0) {
                summaryLine = "Great! You get a refund or zero tax this year.";
                tip1 = "Stay tax-free next year with smart planning.";
            } else if (recommendedNet < 50000) {
                summaryLine = `Your net payable is low at Rs. ${formatINR(recommendedNet)} – Well done!`;
                tip1 = "Optimize further to keep it under Rs. 25,000.";
            } else if (recommendedNet < 200000) {
                summaryLine = `You're paying Rs. ${formatINR(recommendedNet)} net – Save more!`;
                tip1 = "Invest Rs. 1.5 Lakh in eligible options to reduce it by 30%.";
            } else {
                summaryLine = `High net of Rs. ${formatINR(recommendedNet)} – Time to act!`;
                tip1 = "Switch regimes or claim deductions to save Rs. 50,000+.";
            }
            if (recommended === 'Traditional') {
                tip2 = `Traditional saves you Rs. ${formatINR(advantage)} – Maximize 80C/80D.`;
            } else {
                tip2 = `New Regime saves you Rs. ${formatINR(advantage)} – Consider NPS.`;
            }
            if (category === "salaried") {
                tip3 = "Salaried: Focus on HRA, Home Loan, and NPS deductions.";
            } else if (category === "business") {
                tip3 = "Business: Use Presumptive Taxation (44AD) + GST optimization.";
            } else if (category === "freelancer") {
                tip3 = "Freelancer: Claim 44ADA + manage TDS/GST threshold.";
            } else if (category === "investor") {
                tip3 = "Investor: Reinvest Capital Gains under 54/54F.";
            } else {
                tip3 = "Tailored advice available – Book a call!";
            }
            doc.text(summaryLine, 12, y);
            y += 8;
            doc.text("• " + tip1, 12, y); y += 7;
            doc.text("• " + tip2, 12, y); y += 7;
            doc.text("• " + tip3, 12, y); y += 10;
            doc.setFontSize(9);
            doc.text("Our Services:", 12, y);
            y += 7;
            doc.text("• ITR Filing + TDS Refund", 18, y); y += 6;
            doc.text("• GST Return + Compliance", 18, y); y += 6;
            doc.text("• Tax Saving Planning", 18, y); y += 6;
            doc.text("• Notice/Scrutiny Handling", 18, y); y += 12;
            doc.setTextColor(0);
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(11);
            doc.text("WhatsApp: wa.me/919876543210", 105, y, { align: 'center' });
            y += 7;
            doc.text("Call: +91 98765 43210", 105, y, { align: 'center' });
            y += 7;
            doc.text("www.taxeasepro.com", 105, y, { align: 'center' });
            y += 12;
            doc.setFontSize(9);
            doc.setTextColor(100);
            doc.text("Share this report with friends & family!", 105, y, { align: 'center' });
            y += 8;
            doc.setTextColor(120);
            doc.text("System-generated report. For Individuals only. Special incomes approximate. Consult qualified CA for complex cases/Losses/Foreign income.", 105, y, { align: 'center' });
            doc.save(`TaxEasePro_Tax_Report_${g.userName}_FY_2025-26.pdf`);
        }
    }
    function downloadExcel() {
        if (!window.taxData) {
            alert('Please generate computation first');
            return;
        }
        const g = window.taxData;
        const wsData = [
            ["ADVANCED INCOME TAX COMPUTATION – FY 2025-26 (AY 2026-27)"],
            [],
            ["Particulars", "Traditional Regime (Rs.)", "New Regime (Rs.)"],
            ["Gross Normal Income", g.grossNormal, g.grossNormal],
            ["Less: Deductions", g.deductions, 0],
            ["Taxable Normal Income", g.oldTaxableNormal, g.newTaxableNormal],
            ["Tax on Normal Before Rebate", g.oldPreRebate, g.newPreRebate],
            ["Less: 87A Rebate", g.oldRebate, g.newRebate],
            ["Tax on Normal After Rebate", g.oldNormalTax, g.newNormalTax],
            ["STCG Tax u/s 111A", g.oldStcgTax, g.newStcgTax],
            ["LTCG Tax u/s 112A", g.oldLtcg112ATax, g.newLtcg112ATax],
            ["LTCG Tax u/s 112", g.oldLtcg112Tax, g.newLtcg112Tax],
            ["Special Income Tax", g.oldSpecialTax, g.newSpecialTax],
            ["Surcharge", g.oldSurcharge, g.newSurcharge],
            ["Less: Marginal Relief", g.oldMarginalRelief, g.newMarginalRelief],
            ["Tax Before Cess", g.oldTaxBeforeCess, g.newTaxBeforeCess],
            ["4% Cess", g.oldCess, g.newCess],
            ["Final Tax Liability", g.oldTax, g.newTax],
            ["Taxes Paid", g.prepaidTax, g.prepaidTax],
            ["Net Tax Payable (if positive)", Math.max(0, g.oldNetPayable), Math.max(0, g.newNetPayable)],
            ["Refund Amount (if negative)", Math.max(0, -g.oldNetPayable), Math.max(0, -g.newNetPayable)],
            [],
            [
                "Recommended Regime",
                g.oldNetPayable > g.newNetPayable ? "New Regime" : "Traditional Regime",
                ""
            ],
            [],
            ["Generated on", g.timestamp]
        ];
        const ws = XLSX.utils.aoa_to_sheet(wsData);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Tax Computation");
        XLSX.writeFile(wb, "TaxEasePro_Income_Tax_Computation_FY_2025_26.xlsx");
    }
    </script>
</body>
</html>
