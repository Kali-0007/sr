<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Income Tax Computation Tool by TaxEasePro â€“ FY 2025-26 (Accurate & Detailed)</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/3.0.3/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/5.0.2/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body {
            margin: 0;
            font-family: 'Inter', sans-serif;
            background: #000;
            color: #fff;
            line-height: 1.6;
        }
        .tool-container {
            max-width: 950px;
            margin: 40px auto;
            background: #111;
            border-radius: 16px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
            overflow: hidden;
        }
        .tool-header {
            background: linear-gradient(135deg, #4a90e2, #357abd);
            padding: 32px;
            text-align: center;
            position: relative;
        }
        .tool-header i { font-size: 48px; margin-bottom: 12px; display: block; }
        .step-indicator {
            display: flex;
            justify-content: center;
            margin: 20px 0;
            background: #222;
        }
        .step {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: #333;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 12px;
            font-weight: 600;
            color: #fff;
            transition: background 0.3s;
        }
        .step.active { background: #4a90e2; }
        .step.completed { background: #28a745; }
        .tool-form {
            padding: 30px;
        }
        .form-step {
            display: none;
        }
        .form-step.active { display: block; }
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
        }
        label { font-weight: 600; margin-bottom: 6px; display: block; color: #ccc; }
        input, select {
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid #444;
            background: #222;
            color: #fff;
            box-sizing: border-box;
            transition: border 0.3s;
        }
        input:focus, select:focus { border-color: #4a90e2; outline: none; }
        input::placeholder { color: #888; }
        .btn-group {
            display: flex;
            gap: 12px;
            margin-top: 24px;
            justify-content: center;
        }
        button {
            padding: 14px 24px;
            border-radius: 8px;
            border: none;
            font-size: 16px;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.3s;
        }
        .btn-primary { background: #4a90e2; color: #fff; }
        .btn-primary:hover { background: #357abd; }
        .btn-secondary { background: #555; color: #fff; }
        .btn-secondary:hover { background: #666; }
        .reset-btn { background: #dc3545; color: #fff; width: auto; }
        .download-btns {
            display: flex;
            gap: 12px;
            justify-content: center;
            margin-top: 24px;
        }
        .download-btn { padding: 12px 20px; background: #28a745; color: #fff; }
        .download-btn:hover { background: #218838; }
        .computation-results {
            padding: 30px;
            display: none;
            background: #111;
            border-top: 1px solid #333;
        }
        .results-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: #222;
        }
        .results-table th, .results-table td {
            padding: 14px;
            border-bottom: 1px solid #444;
            text-align: left;
        }
        .results-table th { background: #4a90e2; color: #fff; }
        .highlight-tax {
            color: #28a745;
            font-weight: bold;
            font-size: 18px;
        }
        .slab-breakdown {
            margin-top: 10px;
            font-size: 14px;
            color: #ccc;
            background: #333;
            padding: 8px;
            border-radius: 4px;
        }
        small { color: #888; font-size: 12px; }
        @media (max-width: 600px) {
            .form-grid { grid-template-columns: 1fr; }
            .btn-group, .download-btns { flex-direction: column; }
        }
        .close-calculator {
            position: absolute;
            top: 18px;
            right: 22px;
            background: rgba(0,0,0,0.4);
            border: none;
            color: #fff;
            font-size: 22px;
            font-weight: 600;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            cursor: pointer;
            transition: background 0.3s, transform 0.2s;
        }
        .close-calculator:hover {
            background: #dc3545;
            transform: scale(1.1);
        }
        /* Modal Styles */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        .modal-overlay.active {
            display: flex;
        }
        .modal {
            background: #222;
            border-radius: 16px;
            padding: 32px;
            max-width: 400px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            font-family: 'Inter', sans-serif;
        }
        .modal-header {
            text-align: center;
            margin-bottom: 24px;
            color: #fff;
            font-size: 24px;
            font-weight: 700;
        }
        .modal-input-group {
            margin-bottom: 16px;
        }
        .modal-input-group label {
            display: block;
            margin-bottom: 6px;
            color: #ccc;
            font-weight: 600;
        }
        .modal-input-group input {
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid #444;
            background: #333;
            color: #fff;
            box-sizing: border-box;
        }
        .modal-input-group input:focus {
            border-color: #4a90e2;
            outline: none;
        }
        .modal-input-group input::placeholder {
            color: #888;
        }
        .modal-buttons {
            display: flex;
            gap: 12px;
            justify-content: center;
            margin-top: 24px;
        }
        .btn-send {
            background: #4a90e2;
            color: #fff;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s;
        }
        .btn-send:hover:not(:disabled) {
            background: #357abd;
        }
        .btn-send:disabled {
            background: #555;
            cursor: not-allowed;
        }
        .btn-cancel {
            background: #555;
            color: #fff;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s;
        }
        .btn-cancel:hover {
            background: #666;
        }
        .loading {
            display: none;
            text-align: center;
            margin-top: 16px;
            color: #4a90e2;
            font-weight: 600;
        }
        .spinner {
            border: 2px solid #444;
            border-top: 2px solid #4a90e2;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            margin: 0 auto 8px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .error {
            color: #dc3545;
            font-size: 14px;
            margin-top: 8px;
            display: none;
        }
    </style>
</head>
<body>
    <div class="tool-container">
        <header class="tool-header">
            <i class="fas fa-calculator"></i>
            <h1>Income Tax Computation Tool by TaxEasePro</h1>
            <div>Pro Tax, Zero Stress</div>
            <button class="close-calculator">âœ•</button>
        </header>
        <div class="step-indicator" id="stepIndicator">
            <div class="step active" data-step="1">1</div>
            <div class="step" data-step="2">2</div>
            <div class="step" data-step="3">3</div>
            <div class="step" data-step="4">4</div>
            <div class="step" data-step="5">5</div>
        </div>
        <form id="taxForm" class="tool-form">
            <div class="form-step active" data-step="1">
                <h3><i class="fas fa-user"></i> Step 1: Tax Profile</h3>
                <div class="form-grid">
                    <div>
                        <label>Your Name (Optional)</label>
                        <input type="text" id="userName" placeholder="e.g., John Doe">
                    </div>
                    <div>
                        <label>Select Your Category <span style="color:#ff6b6b;">(Required)</span></label>
                        <select id="userCategory" required>
                            <option value="">Please select</option>
                            <option value="salaried">Salaried Employee</option>
                            <option value="business">Business Owner / Proprietor</option>
                            <option value="freelancer">Freelancer / Professional (CA, Doctor, Lawyer, Consultant etc.)</option>
                            <option value="investor">Investor / Rental Income Only</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div>
                        <label>Age Category</label>
                        <select id="ageGroup">
                            <option value="under60">Below 60 years</option>
                            <option value="senior">60-79 years (Senior)</option>
                            <option value="superSenior">80+ years (Super Senior)</option>
                        </select>
                    </div>
                    <div>
                        <label>Residency</label>
                        <select id="residentialStatus">
                            <option value="resident">Resident Indian</option>
                            <option value="nri">Non-Resident Indian</option>
                        </select>
                    </div>
                    <div style="grid-column: 1 / -1;">
                        <label>Annual Salary (pre-exemptions, â‚¹)</label>
                        <input type="text" id="totalSalary" value="0" placeholder="e.g., 1000000" oninput="formatNumber(this)">
                        <small>Basic pay + allowances</small>
                    </div>
                    <div>
                        <label>HRA Relief (â‚¹)</label>
                        <input type="text" id="hraExemption" value="0" oninput="formatNumber(this)">
                    </div>
                    <div>
                        <label>Additional Exemptions (â‚¹)</label>
                        <input type="text" id="otherExemptions" value="0" oninput="formatNumber(this)">
                    </div>
                </div>
                <div class="btn-group">
                    <button type="button" class="btn-secondary">Next</button>
                </div>
            </div>
            <div class="form-step" data-step="2">
                <h3><i class="fas fa-chart-line"></i> Step 2: Income Streams</h3>
                <div class="form-grid">
                    <div>
                        <label>Other Earnings (â‚¹)</label>
                        <input type="text" id="otherIncome" value="0" oninput="formatNumber(this)">
                    </div>
                    <div>
                        <label>Rent Received (Gross, â‚¹)</label>
                        <input type="text" id="rentalIncome" value="0" oninput="formatNumber(this)">
                    </div>
                    <div>
                        <label>Municipal Taxes Paid (â‚¹)</label>
                        <input type="text" id="municipalTaxes" value="0" oninput="formatNumber(this)">
                    </div>
                    <div>
                        <label>Property Loan Interest - Let Out (â‚¹)</label>
                        <input type="text" id="homeLoanLetOut" value="0" oninput="formatNumber(this)">
                    </div>
                    <div>
                        <label>Property Loan Interest - Self Occupied (max â‚¹2L, â‚¹)</label>
                        <input type="text" id="homeLoanSelf" value="0" oninput="formatNumber(this)">
                    </div>
                    <div>
                        <label>Business Earnings (â‚¹)</label>
                        <input type="text" id="businessIncome" value="0" oninput="formatNumber(this)">
                    </div>
                    <div>
                        <label>Short-Term Capital Gains u/s 111A (Equity STT, â‚¹)</label>
                        <input type="text" id="stcg111A" value="0" oninput="formatNumber(this)">
                    </div>
                    <div>
                        <label>Long-Term Capital Gains u/s 112A (Equity LTCG, â‚¹)</label>
                        <input type="text" id="ltcg112A" value="0" oninput="formatNumber(this)">
                    </div>
                    <div>
                        <label>Long-Term Capital Gains u/s 112 (Other LTCG, â‚¹)</label>
                        <input type="text" id="ltcg112" value="0" oninput="formatNumber(this)">
                    </div>
                    <div>
                        <label>Special Rate Incomes (Lottery, Crypto, etc., â‚¹)</label>
                        <input type="text" id="specialIncome" value="0" oninput="formatNumber(this)">
                    </div>
                    <div>
                        <label>Agricultural Income (â‚¹, optional)</label>
                        <input type="text" id="agriIncome" value="0" oninput="formatNumber(this)">
                    </div>
                </div>
                <div class="btn-group">
                    <button type="button" class="btn-secondary">Previous</button>
                    <button type="button" class="btn-primary">Next</button>
                </div>
            </div>
            <div class="form-step" data-step="3">
                <h3><i class="fas fa-shield-alt"></i> Step 3: Allowable Deductions (Traditional Regime)</h3>
                <p style="color: #ccc;">New regime limits to standard deduction only.</p>
                <div class="form-grid">
                    <div>
                        <label>80C Investments (max â‚¹1.5L, â‚¹)</label>
                        <input type="text" id="section80C" value="0" oninput="formatNumber(this)">
                    </div>
                    <div>
                        <label>80D Insurance (â‚¹)</label>
                        <input type="text" id="section80D" value="0" oninput="formatNumber(this)">
                    </div>
                    <div>
                        <label>80G Contributions (â‚¹)</label>
                        <input type="text" id="section80G" value="0" oninput="formatNumber(this)">
                    </div>
                    <div>
                        <label>80E Loan Interest (â‚¹)</label>
                        <input type="text" id="section80E" value="0" oninput="formatNumber(this)">
                    </div>
                    <div>
                        <label>80TTA Savings (max â‚¹10K, â‚¹)</label>
                        <input type="text" id="section80TTA" value="0" oninput="formatNumber(this)">
                    </div>
                    <div style="grid-column: 1 / -1;">
                        <label>Further Deductions (â‚¹)</label>
                        <input type="text" id="otherDeductions" value="0" oninput="formatNumber(this)">
                    </div>
                </div>
                <div class="btn-group">
                    <button type="button" class="btn-secondary">Previous</button>
                    <button type="button" class="btn-primary">Next</button>
                </div>
            </div>
            <div class="form-step" data-step="4">
                <h3><i class="fas fa-money-check"></i> Step 4: Taxes Already Paid</h3>
                <div class="form-grid">
                    <div>
                        <label>TDS Deducted (â‚¹)</label>
                        <input type="text" id="tds" value="0" oninput="formatNumber(this)">
                    </div>
                    <div>
                        <label>Advance Tax Paid (â‚¹)</label>
                        <input type="text" id="advanceTax" value="0" oninput="formatNumber(this)">
                    </div>
                    <div>
                        <label>Self-Assessment Tax Paid (â‚¹)</label>
                        <input type="text" id="selfAssessmentTax" value="0" oninput="formatNumber(this)">
                    </div>
                </div>
                <div class="btn-group">
                    <button type="button" class="btn-secondary">Previous</button>
                    <button type="button" id="generateBtn" class="btn-primary">Generate Report</button>
                </div>
            </div>
        </form>
        <div id="results" class="computation-results">
            <h2><i class="fas fa-file-invoice"></i> Computation Summary</h2>
            <p style="color: #ccc; text-align: center;">For Individuals only. Special incomes approximate. Consult CA for complex cases/Losses/Foreign income.</p>
            <div id="summaryResults" style="text-align: center; margin-bottom: 20px;"></div>
            <table class="results-table" style="display: none;">
                <thead>
                    <tr>
                        <th>Component</th>
                        <th>Traditional Regime</th>
                        <th>New Regime</th>
                    </tr>
                </thead>
                <tbody id="resultsTable">
                </tbody>
            </table>
            <div class="download-btns">
                <button class="action-btn" onclick="openModal()" style="background: #25d366;">
    <i class="fas fa-envelope"></i> Get Detailed Report on Email
</button>
               
            </div>
            <button type="button" class="reset-btn" style="margin-top: 20px; display: block; margin-left: auto; margin-right: auto;">New Computation</button>
        </div>
    </div>

    <!-- Modal -->
    <div class="modal-overlay" id="emailModal">
        <div class="modal">
            <div class="modal-header">Receive Your Tax Report</div>
            <div class="modal-input-group">
                <label>Full Name</label>
                <input type="text" id="modalFullName" placeholder="Enter your full name" required>
            </div>
            <div class="modal-input-group">
                <label>Email Address</label>
                <input type="email" id="modalEmail" placeholder="Enter your email" required>
                <div class="error" id="emailError">Please enter a valid email address.</div>
            </div>
            <div class="loading" id="loadingSpinner">
                <div class="spinner"></div>
                Sending...
           </div>
            <div class="modal-buttons">
                <button class="btn-send" id="sendReportBtn">Send Report</button>
                <button class="btn-cancel" id="cancelBtn" onclick="closeModal()">Cancel</button>
            </div>

            <div style="margin-top: 20px; padding-top: 15px; border-top: 1px dashed #ddd; text-align: left;">
                <p style="font-size: 11px; color: #666; line-height: 1.5; margin: 0;">
                    ðŸ”’ <b>Privacy Note:</b> We value your privacy. Your financial data is encrypted and used only to generate this report. We never share your details with third parties.
                </p>
                <p style="font-size: 10px; color: #999; margin-top: 5px; font-style: italic;">
                    *This report is a system-generated estimation. Please consult a CA for official tax filing.
                </p>
            </div>
            </div>
    </div>

    <script>
    function formatNumber(input) {
        let value = input.value.replace(/,/g, '');
        if (!isNaN(value) && value !== '') {
            let num = parseFloat(value);
            input.value = new Intl.NumberFormat('en-IN').format(num);
        }
    }
    function parseFormatted(value) {
        return Number(value.replace(/,/g, '')) || 0;
    }
    function formatINR(n) {
        const amount = Math.round(Number(n) || 0);
        if (amount === 0) return '0';
        return 'Rs. ' + new Intl.NumberFormat('en-IN', { maximumFractionDigits: 0 }).format(amount);
    }
    function updateSteps(currentStep) {
        document.querySelectorAll('.step').forEach((step, index) => {
            step.classList.remove('active', 'completed');
            if (index < currentStep - 1) step.classList.add('completed');
            if (index === currentStep - 1) step.classList.add('active');
        });
        document.querySelectorAll('.form-step').forEach((s, i) => {
            s.classList.toggle('active', i === currentStep - 1);
        });
    }
    function nextStep(step) { updateSteps(step); }
    function prevStep(step) { updateSteps(step); }
    function closeCalculator() {
    resetForm(); // optional
    window.location.href = "index.html";
}
    function resetForm() {
        document.getElementById('taxForm').reset();
        document.getElementById('results').style.display = 'none';
        updateSteps(1);
        delete window.taxData;
    }
    function calculateTax(regime, ageGroup, isResident, grossNormal, deductions, stcg111A, ltcg112A, ltcg112, specialIncome, agriIncome) {
        let stdDeduction = regime === 'old' ? 50000 : 75000;
        let normalDeductions = regime === 'old' ? deductions : 0;
        let taxableNormal = Math.max(0, grossNormal - normalDeductions - stdDeduction);
        let taxableNormalForRate = taxableNormal;
        let agri = Number(agriIncome);
        if (agri > 5000) {
            taxableNormalForRate += agri;
        }
        let exemptionLimit = 0;
        if (regime === 'old') {
            exemptionLimit = isResident ? (ageGroup === 'under60' || !isResident ? 250000 : ageGroup === 'senior' ? 300000 : 500000) : 250000;
        } else {
            exemptionLimit = 400000;
        }
        let normalTax = 0;
        let slabs = [];
        if (regime === 'new') {
            normalTax = calculateSlabTax(taxableNormalForRate, [
                {min: 400000, max: 800000, rate: 0.05},
                {min: 800000, max: 1200000, rate: 0.10},
                {min: 1200000, max: 1600000, rate: 0.15},
                {min: 1600000, max: 2000000, rate: 0.20},
                {min: 2000000, max: 2400000, rate: 0.25},
                {min: 2400000, max: Infinity, rate: 0.30}
            ], slabs, exemptionLimit);
        } else {
            normalTax = calculateSlabTax(taxableNormalForRate, [
                {min: exemptionLimit, max: 500000, rate: 0.05},
                {min: 500000, max: 1000000, rate: 0.20},
                {min: 1000000, max: Infinity, rate: 0.30}
            ], slabs, exemptionLimit);
        }
        if (agri > 5000) {
            let agriTax = calculateSlabTax(exemptionLimit + agri, regime === 'new' ? [
                {min: 400000, max: 800000, rate: 0.05},
                {min: 800000, max: 1200000, rate: 0.10},
                {min: 1200000, max: 1600000, rate: 0.15},
                {min: 1600000, max: 2000000, rate: 0.20},
                {min: 2000000, max: 2400000, rate: 0.25},
                {min: 2400000, max: Infinity, rate: 0.30}
            ] : [
                {min: exemptionLimit, max: 500000, rate: 0.05},
                {min: 500000, max: 1000000, rate: 0.20},
                {min: 1000000, max: Infinity, rate: 0.30}
            ], [], exemptionLimit);
            normalTax -= agriTax;
        }
        let preRebateNormalTax = Math.round(normalTax);
        let rebate = 0;
        let rebateLimit = regime === 'old' ? 500000 : 1200000;
        let rebateMax = regime === 'old' ? 12500 : 60000;
        if (isResident && taxableNormal <= rebateLimit) {
            rebate = Math.min(preRebateNormalTax, rebateMax);
        }
        normalTax = Math.max(0, preRebateNormalTax - rebate);
        let stcgTax = Math.round(stcg111A * 0.20);
        let ltcg112ATax = Math.round(Math.max(0, ltcg112A - 125000) * 0.125);
        let ltcg112Tax = Math.round(ltcg112 * 0.125);
        let specialTax = Math.round(specialIncome * 0.30);
        let totalSpecialTax = stcgTax + ltcg112ATax + ltcg112Tax + specialTax;
        let taxBeforeSurcharge = normalTax + totalSpecialTax;
        let totalTaxable = taxableNormal + stcg111A + Math.max(0, ltcg112A - 125000) + ltcg112 + specialIncome;
        let surcharge = calculateSurcharge(taxBeforeSurcharge, totalTaxable, regime);
        let taxWithSurcharge = taxBeforeSurcharge + surcharge;
        let marginalRelief = calculateMarginalRelief(taxBeforeSurcharge, surcharge, totalTaxable, regime);
        surcharge -= marginalRelief;
        let taxBeforeCess = taxBeforeSurcharge + surcharge;
        let cess = Math.round(taxBeforeCess * 0.04);
        let finalTax = taxBeforeCess + cess;
        return {
            tax: Math.round(finalTax),
            preRebateTax: preRebateNormalTax,
            rebateAmount: rebate,
            slabs: slabs.join(', '),
            stdDeduction,
            taxableIncome: totalTaxable,
            surcharge: surcharge,
            cess: cess,
            taxBeforeCess: taxBeforeCess,
            taxAfterRebate: normalTax + totalSpecialTax,
            normalTax: normalTax,
            stcgTax: stcgTax,
            ltcg112ATax: ltcg112ATax,
            ltcg112Tax: ltcg112Tax,
            specialTax: specialTax,
            marginalRelief: marginalRelief
        };
    }
    function calculateSlabTax(income, slabRates, slabs, exemption) {
        let tax = 0;
        let prevMax = exemption;
        for (let slab of slabRates) {
            if (income > prevMax) {
                let amount = Math.min(income, slab.max) - prevMax;
                tax += amount * slab.rate;
                slabs.push(`${slab.rate * 100}% on Rs. ${(prevMax / 100000).toFixed(1)}L - Rs. ${(slab.max / 100000).toFixed(1)}L`);
            }
            prevMax = slab.max;
            if (income <= slab.max) break;
        }
        return tax;
    }
    function calculateSurcharge(tax, income, regime) {
        let rate = 0;
        if (income > 5000000 && income <= 10000000) rate = 0.10;
        else if (income <= 20000000) rate = 0.15;
        else if (income <= 50000000) rate = 0.25;
        else if (income > 50000000) rate = regime === 'new' ? 0.25 : 0.37;
        return Math.round(tax * rate);
    }
    function calculateMarginalRelief(taxBeforeSurcharge, surcharge, income, regime) {
        let relief = 0;
        const thresholds = [5000000, 10000000, 20000000, 50000000];
        for (let threshold of thresholds) {
            if (income > threshold) {
                let taxAtThreshold = calculateTaxAtThreshold(threshold, regime, taxBeforeSurcharge / (income - threshold + taxBeforeSurcharge) * (income - threshold)); // approximate
                let surchargeAtThreshold = calculateSurcharge(taxAtThreshold, threshold, regime);
                let totalAtThreshold = taxAtThreshold + surchargeAtThreshold;
                let excess = (taxBeforeSurcharge + surcharge) - totalAtThreshold;
                if (excess > (income - threshold)) {
                    relief += excess - (income - threshold);
                }
            }
        }
        return relief;
    }
    function calculateTaxAtThreshold(threshold, regime, proportion) {
        // Simplified, assume same proportion
        return proportion;
    }
    document.addEventListener('DOMContentLoaded', function() {
        updateSteps(1);
        document.querySelector('.close-calculator').addEventListener('click', closeCalculator);
        document.querySelector('.reset-btn').addEventListener('click', resetForm);
        
        
        document.getElementById('sendReportBtn').addEventListener('click', sendReport);
        document.getElementById('cancelBtn').addEventListener('click', closeModal);
        document.querySelectorAll('.form-step .btn-group').forEach(group => {
            const buttons = group.querySelectorAll('button[type="button"]');
            const currentStepEl = group.closest('.form-step');
            const currentStep = parseInt(currentStepEl.dataset.step);
            if (buttons.length === 1) {
                // Step 1: only next
                buttons[0].addEventListener('click', () => nextStep(2));
            } else {
                // Previous
                buttons[0].addEventListener('click', () => prevStep(currentStep - 1));
                // Next, if not generate
                if (buttons[1].id !== 'generateBtn') {
                    buttons[1].addEventListener('click', () => nextStep(currentStep + 1));
                }
            }
        });
        document.getElementById('generateBtn').addEventListener('click', function(e) {
            e.preventDefault();
            const userName = document.getElementById('userName').value.trim() || 'User';
            const userCategory = document.getElementById('userCategory').value;
            if (!userCategory) {
                alert('Please select your category.');
                return;
            }
            const ageGroup = document.getElementById('ageGroup').value;
            const residentialStatus = document.getElementById('residentialStatus').value;
            const isResident = residentialStatus === 'resident';
            const basicSalary = parseFormatted(document.getElementById('totalSalary').value);
            const otherIncome = parseFormatted(document.getElementById('otherIncome').value);
            const rentalIncome = parseFormatted(document.getElementById('rentalIncome').value);
            const municipalTaxes = parseFormatted(document.getElementById('municipalTaxes').value);
            const homeLoanLetOut = parseFormatted(document.getElementById('homeLoanLetOut').value);
            const hraExemption = parseFormatted(document.getElementById('hraExemption').value);
            const otherExemptions = parseFormatted(document.getElementById('otherExemptions').value);
            let section80C = parseFormatted(document.getElementById('section80C').value);
            section80C = Math.min(section80C, 150000);
            let section80D = parseFormatted(document.getElementById('section80D').value);
            const max80D = ageGroup === 'under60' ? 25000 : 50000;
            section80D = Math.min(section80D, max80D);
            const section80G = parseFormatted(document.getElementById('section80G').value);
            const section80E = parseFormatted(document.getElementById('section80E').value);
            let section80TTA = parseFormatted(document.getElementById('section80TTA').value);
            section80TTA = Math.min(section80TTA, 10000);
            let homeLoanSelf = parseFormatted(document.getElementById('homeLoanSelf').value);
            homeLoanSelf = Math.min(homeLoanSelf, 200000);
            const furtherDeductions = parseFormatted(document.getElementById('otherDeductions').value);
            const businessIncome = parseFormatted(document.getElementById('businessIncome').value);
            const stcg111A = parseFormatted(document.getElementById('stcg111A').value);
            const ltcg112A = parseFormatted(document.getElementById('ltcg112A').value);
            const ltcg112 = parseFormatted(document.getElementById('ltcg112').value);
            const specialIncome = parseFormatted(document.getElementById('specialIncome').value);
            const agriIncome = parseFormatted(document.getElementById('agriIncome').value);
            const tds = parseFormatted(document.getElementById('tds').value);
            const advanceTax = parseFormatted(document.getElementById('advanceTax').value);
            const selfAssessmentTax = parseFormatted(document.getElementById('selfAssessmentTax').value);
            const prepaidTax = tds + advanceTax + selfAssessmentTax;
            const netRentalLetOut = rentalIncome - municipalTaxes - 0.3 * (rentalIncome - municipalTaxes) - homeLoanLetOut;
            const grossNormal = basicSalary + businessIncome + otherIncome + netRentalLetOut - homeLoanSelf;
            const oldRegimeDeductions = section80C + section80D + section80G + section80E + section80TTA + hraExemption + otherExemptions + furtherDeductions;
            let oldResult = calculateTax('old', ageGroup, isResident, grossNormal, oldRegimeDeductions, stcg111A, ltcg112A, ltcg112, specialIncome, agriIncome);
            let newResult = calculateTax('new', ageGroup, isResident, grossNormal, 0, stcg111A, ltcg112A, ltcg112, specialIncome, agriIncome);
            let oldNetPayable = oldResult.tax - prepaidTax;
            let newNetPayable = newResult.tax - prepaidTax;
            const regimeAdvantage = oldNetPayable - newNetPayable;
            const recommendedRegime = oldNetPayable > newNetPayable ? 'New' : 'Traditional';
            const savings = Math.abs(regimeAdvantage);
            window.taxData = {
                timestamp: new Date().toLocaleString('en-IN'),
                userName: userName,
                userCategory: userCategory,
                basicSalary,
                businessIncome,
                otherIncome,
                rentalIncome,
                municipalTaxes,
                homeLoanLetOut,
                netRentalLetOut,
                homeLoanSelf,
                stcg111A,
                ltcg112A,
                ltcg112,
                specialIncome,
                agriIncome,
                hraExemption,
                otherExemptions,
                section80C,
                section80D,
                section80G,
                section80E,
                section80TTA,
                furtherDeductions,
                grossNormal,
                deductions: oldRegimeDeductions,
                oldStd: oldResult.stdDeduction,
                newStd: newResult.stdDeduction,
                oldTaxableNormal: Math.max(0, grossNormal - oldRegimeDeductions - oldResult.stdDeduction),
                newTaxableNormal: Math.max(0, grossNormal - newResult.stdDeduction),
                oldPreRebate: oldResult.preRebateTax,
                newPreRebate: newResult.preRebateTax,
                oldRebate: oldResult.rebateAmount,
                newRebate: newResult.rebateAmount,
                oldNormalTax: oldResult.normalTax,
                newNormalTax: newResult.normalTax,
                oldStcgTax: oldResult.stcgTax,
                newStcgTax: newResult.stcgTax,
                oldLtcg112ATax: oldResult.ltcg112ATax,
                newLtcg112ATax: newResult.ltcg112ATax,
                oldLtcg112Tax: oldResult.ltcg112Tax,
                newLtcg112Tax: newResult.ltcg112Tax,
                oldSpecialTax: oldResult.specialTax,
                newSpecialTax: newResult.specialTax,
                oldSurcharge: oldResult.surcharge,
                newSurcharge: newResult.surcharge,
                oldMarginalRelief: oldResult.marginalRelief,
                newMarginalRelief: newResult.marginalRelief,
                oldTaxBeforeCess: oldResult.taxBeforeCess,
                newTaxBeforeCess: newResult.taxBeforeCess,
                oldCess: oldResult.cess,
                newCess: newResult.cess,
                oldTax: oldResult.tax,
                newTax: newResult.tax,
                prepaidTax,
                oldNetPayable,
                newNetPayable,
                savings,
                recommendedRegime,
                oldSlabs: oldResult.slabs,
                newSlabs: newResult.slabs
            };
            document.getElementById('summaryResults').innerHTML = `
                <h3>Final Tax Payable</h3>
                <table style="margin: auto; border: 1px solid #444; background: #222;">
                    <tr><th>Regime</th><th>Tax Payable</th></tr>
                    <tr><td>Traditional</td><td>${formatINR(oldResult.tax)}</td></tr>
                    <tr><td>New</td><td>${formatINR(newResult.tax)}</td></tr>
                </table>
                <p style="text-align:center; color:#4a90e2; font-size:18px; margin-top:25px; font-weight:600;">
                    For complete and detailed computation, please get the report on email.
                </p>
            `;
            document.getElementById('results').style.display = 'block';
            updateSteps(5);
        });
    });

    function openModal() {
        if (typeof window.taxData === 'undefined') {
            alert('Please calculate tax first.');
            return;
        }
        document.getElementById('modalFullName').value = window.taxData.userName;
        document.getElementById('emailModal').classList.add('active');
        document.getElementById('emailError').style.display = 'none';
    }

    function closeModal() {
        document.getElementById('emailModal').classList.remove('active');
        document.getElementById('sendReportBtn').disabled = false;
        document.getElementById('loadingSpinner').style.display = 'none';
        document.getElementById('modalFullName').value = '';
        document.getElementById('modalEmail').value = '';
    }

    async function generatePDFBase64() {
        return new Promise((resolve, reject) => {
            if (typeof window.taxData === 'undefined') {
                reject('No tax data available');
                return;
            }
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'a4');
            const g = window.taxData;
            let rendered = false;
            // Logo Logic (Optional - Skip if file not found)
            let logoLoaded = false;
let logo;  // <-- Ye line add kar do (bas itni si)
            try {
                logo = new Image();
logo.crossOrigin = "anonymous";  // Optional but good
logo.src = 'logo.png';
                logo.src = 'logo.png';
                logo.onload = function () { logoLoaded = true; renderContent(); };
                logo.onerror = function () {
    logoLoaded = false;
    renderContent();
};
                setTimeout(() => {
    if (!rendered) {
        logoLoaded = false;
        renderContent();
    }
}, 1500);
            } catch (e) {
                logoLoaded = false;
                renderContent();
            }
            function renderContent() {
                if (rendered) return;
                rendered = true;
                // --- HEADER SECTION (0-45mm) ---
                doc.setFillColor(0, 51, 102);
                doc.rect(0, 0, 210, 45, 'F');
                // Top Center Title
                doc.setTextColor(192, 192, 192);
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(18);
                doc.text('Income Tax Computation (FY 2025-26)', 105, 8, { align: 'center' });
                // Brand Name "TaxEasePro" with Shadow/Shiny effect
                const brandX = logoLoaded ? 45 : 15;
                doc.setFontSize(36);
                doc.setTextColor(218, 165, 32); // Darker gold for shadow
                doc.text('TaxEasePro', brandX + 0.5, 20.5);
                doc.setTextColor(255, 215, 0); // Gold
                doc.text('TaxEasePro', brandX, 20);
                // Tagline
                doc.setTextColor(255, 255, 255);
                doc.setFont('helvetica', 'italic');
                doc.setFontSize(14);
                doc.text('Pro Tax, Zero Stress', brandX, 28);
                // Contacts in Header
                doc.setFont('helvetica', 'normal');
                doc.setFontSize(9);
                doc.text('support@taxeasepro.com | wa.me/+919876543210', brandX, 36);
                doc.setDrawColor(255, 255, 255);
                doc.setLineWidth(0.1);
                doc.line(brandX, 37, brandX + 37, 37); // Underline email
                doc.line(brandX + 43, 37, brandX + 78, 37); // Underline WhatsApp
                if (logoLoaded) doc.addImage(logo, 'PNG', 10, 10, 25, 25);
                // Greeting
                let y = 52;
                doc.setTextColor(0);
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(13);
                doc.text(`Hello ${g.userName}! Here is your Detailed Tax Computation`, 10, y);
                // --- TABLE DATA (DO NOT MODIFY STRUCTURE) ---
                const recommended = g.recommendedRegime;
                const advantage = g.savings;
                const tableData = [
                    ['Component', 'Traditional Regime (Rs.)', 'New Regime (Rs.)'],
                    ['Income Heads'],
                    ['Basic Salary', formatINR(g.basicSalary), formatINR(g.basicSalary)],
                    ['Business Income', formatINR(g.businessIncome), formatINR(g.businessIncome)],
                    ['Other Income', formatINR(g.otherIncome), formatINR(g.otherIncome)],
                    ['Gross Rental Income', formatINR(g.rentalIncome), formatINR(g.rentalIncome)],
                    ['Less: Municipal Taxes', formatINR(g.municipalTaxes), formatINR(g.municipalTaxes)],
                    ['Less: 30% Std Ded on Rental', formatINR(0.3 * (g.rentalIncome - g.municipalTaxes)), formatINR(0.3 * (g.rentalIncome - g.municipalTaxes))],
                    ['Less: Interest Let Out', formatINR(g.homeLoanLetOut), formatINR(g.homeLoanLetOut)],
                    ['Net Rental Income', formatINR(g.netRentalLetOut), formatINR(g.netRentalLetOut)],
                    ['Less: Self Occupied Interest', formatINR(g.homeLoanSelf), formatINR(g.homeLoanSelf)],
                    ['STCG u/s 111A', formatINR(g.stcg111A), formatINR(g.stcg111A)],
                    ['LTCG u/s 112A', formatINR(g.ltcg112A), formatINR(g.ltcg112A)],
                    ['LTCG u/s 112', formatINR(g.ltcg112), formatINR(g.ltcg112)],
                    ['Special Rate Income', formatINR(g.specialIncome), formatINR(g.specialIncome)],
                    ['Agricultural Income (Exempt)', formatINR(g.agriIncome), formatINR(g.agriIncome)],
                    ['Gross Total Income', formatINR(g.grossNormal + g.stcg111A + g.ltcg112A + g.ltcg112 + g.specialIncome + g.agriIncome), formatINR(g.grossNormal + g.stcg111A + g.ltcg112A + g.ltcg112 + g.specialIncome + g.agriIncome)],
                    [''],
                    ['Deductions'],
                    ['HRA Relief', formatINR(g.hraExemption), '0'],
                    ['Additional Exemptions', formatINR(g.otherExemptions), '0'],
                    ['Section 80C Investments', formatINR(g.section80C), '0'],
                    ['Section 80D Insurance', formatINR(g.section80D), '0'],
                    ['Other Deductions (80G, 80E, 80TTA, etc.)', formatINR(g.section80G + g.section80E + g.section80TTA + g.furtherDeductions), '0'],
                    ['Total Deductions (excl. Std. Ded.)', formatINR(g.deductions), '0'],
                    ['Less: Standard Deduction', formatINR(g.oldStd), formatINR(g.newStd)],
                    [''],
                    ['Taxable Normal Income', formatINR(g.oldTaxableNormal), formatINR(g.newTaxableNormal)],
                    [''],
                    ['Tax Computation'],
                    ['Tax on Normal at Slabs', formatINR(g.oldPreRebate), formatINR(g.newPreRebate)],
                    ['Less: Section 87A Rebate', formatINR(g.oldRebate), formatINR(g.newRebate)],
                    ['Tax on Normal After Rebate', formatINR(g.oldNormalTax), formatINR(g.newNormalTax)],
                    ['STCG Tax (u/s 111A @20%)', formatINR(g.oldStcgTax), formatINR(g.newStcgTax)],
                    ['LTCG Tax (u/s 112A @12.5% >1.25L)', formatINR(g.oldLtcg112ATax), formatINR(g.newLtcg112ATax)],
                    ['LTCG Tax (u/s 112 @12.5%)', formatINR(g.oldLtcg112Tax), formatINR(g.newLtcg112Tax)],
                    ['Special Income Tax (@30%)', formatINR(g.oldSpecialTax), formatINR(g.newSpecialTax)],
                    ['Add: Surcharge', formatINR(g.oldSurcharge), formatINR(g.newSurcharge)],
                    ['Less: Marginal Relief', formatINR(g.oldMarginalRelief), formatINR(g.newMarginalRelief)],
                    ['Tax Before Cess', formatINR(g.oldTaxBeforeCess), formatINR(g.newTaxBeforeCess)],
                    ['Add: 4% Health & Education Cess', formatINR(g.oldCess), formatINR(g.newCess)],
                    ['Net Tax Liability', formatINR(g.oldTax), formatINR(g.newTax)],
                    [''],
                    ['Payments'],
                    ['Taxes Already Paid (TDS + Advance + Self)', formatINR(g.prepaidTax), formatINR(g.prepaidTax)],
                    ['Net Tax Payable (if positive)', formatINR(Math.max(0, g.oldNetPayable)), formatINR(Math.max(0, g.newNetPayable))],
                    ['Refund Amount (if negative)', formatINR(Math.max(0, -g.oldNetPayable)), formatINR(Math.max(0, -g.newNetPayable))],
                    [''],
                    ['Recommendation', recommended, `Savings: Rs. ${formatINR(advantage)}`]
                ];
                doc.autoTable({
                    startY: 60,
                    head: [['Component', 'Traditional Regime (Rs.)', 'New Regime (Rs.)']],
                    body: tableData.slice(1),
                    theme: 'grid',
                    styles: { fontSize: 9, cellPadding: 4, lineWidth: 0.2, lineColor: [160, 160, 160], font: 'helvetica' },
                    headStyles: { fillColor: [0, 51, 102], textColor: 255, fontStyle: 'bold', fontSize: 10 },
                    columnStyles: { 0: { cellWidth: 100 }, 1: { halign: 'right' }, 2: { halign: 'right' } },
                    margin: { left: 10, right: 10 },
                    didParseCell: function (data) {
                        const rowText = data.row.raw[0];
                        const sections = ['Income Heads', 'Deductions', 'Tax Computation', 'Payments'];
                        if (sections.includes(rowText)) {
                            data.cell.styles.fillColor = [230, 230, 230];
                            data.cell.styles.fontStyle = 'bold';
                        }
                        if (data.section === 'body' && data.row.index % 2 === 0 && !sections.includes(rowText) && rowText !== '') {
                            data.cell.styles.fillColor = [245, 247, 250];
                        }
                        if (rowText === 'Recommendation') {
                            data.cell.styles.fillColor = [220, 252, 231];
                            data.cell.styles.fontStyle = 'bold';
                            if (data.column.index === 2) {
                                data.cell.styles.fontSize = 10;
                            }
                        }
                        // Numeric styling
                        if (data.column.index > 0 && data.section === 'body') {
                            const cleanVal = data.cell.text[0].replace(/[^0-9.-]/g, '');
                            if (parseFloat(cleanVal) > 0) data.cell.styles.fontStyle = 'bold';
                        }
                    },
                    hooks: {
                        willDrawCell: function (data) {
                            if (data.row.raw[0] === 'Recommendation' && data.cursor.y > 240) {
                                doc.addPage();
                                data.cursor.y = 20;
                            }
                        }
                    }
                });
                // --- TAX SAVING TIPS ---
                y = doc.lastAutoTable.finalY + 8;
                if (y > 240) { doc.addPage(); y = 20; }
                doc.setFillColor(200, 255, 200);
                doc.setDrawColor(0, 128, 0);
                doc.setLineWidth(0.6);
                doc.rect(10, y, 190, 40, 'FD');
               
                doc.setTextColor(0);
                doc.setFontSize(14);
                doc.setFont('helvetica', 'bold');
                doc.text('Your Personalized Tax Saving Tips', 15, y + 6);
                doc.setFontSize(9);
                doc.setFont('helvetica', 'normal');
                doc.text('â€¢ Great! You get a refund or zero tax this year.', 15, y + 14);
                doc.text('â€¢ Stay tax-free next year with smart planning.', 15, y + 20);
                doc.text(`â€¢ New Regime saves you Rs. ${formatINR(advantage)} â€“ Consider NPS.`, 15, y + 26);
                doc.text('â€¢ Business: Use Presumptive Taxation (44AD) + GST optimization.', 15, y + 32);
                // --- PREMIUM SERVICES (Force New Page logic) ---
                y += 48;
                if (y > 180) { doc.addPage(); y = 20; }
               
                // Header: Dark Purple Background
                doc.setFillColor(48, 25, 52);
                doc.rect(10, y, 190, 14, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(14);
                doc.setFont('helvetica', 'bold');
                doc.text('Our Premium Services', 105, y + 9, { align: 'center' });
                const services = [
                    { t: 'ITR Filing + TDS Refund', d: 'â€¢ Seamless filing with maximum refund' },
                    { t: 'GST Return + Compliance', d: 'â€¢ Hassle-free monthly/quarterly filings' },
                    { t: 'Tax Saving Planning', d: 'â€¢ Personalized strategies to save more' },
                    { t: 'Notice/Scrutiny Handling', d: 'â€¢ Expert support during assessments' }
                ];
                let sy = y + 18;
                services.forEach((s, i) => {
                    let sx = (i % 2 === 0) ? 10 : 108;
                    let rowY = sy + (Math.floor(i / 2) * 32); // Adjusted gap for better layout
                   
                    // Shadow
                    doc.setFillColor(230, 230, 230);
                    doc.rect(sx + 0.6, rowY + 0.6, 92, 30, 'F');
                   
                    // Main Card: Dark Purple Background
                    doc.setFillColor(48, 25, 52);
                    doc.setDrawColor(218, 165, 32); // Gold Border
                    doc.setLineWidth(0.5);
                    doc.rect(sx, rowY, 92, 30, 'FD');
                   
                    // Title: Bright Gold
                    doc.setTextColor(255, 215, 0);
                    doc.setFontSize(11);
                    doc.setFont('helvetica', 'bold');
                    doc.text(s.t, sx + 5, rowY + 8);
                   
                    // Underline: Silver
                    doc.setDrawColor(192, 192, 192);
                    doc.setLineWidth(0.2);
                    doc.line(sx + 5, rowY + 10, sx + 45, rowY + 10);
                   
                    // Description: Light Silver/White (High contrast on purple)
                    doc.setTextColor(220, 220, 220);
                    doc.setFontSize(8.5);
                    doc.setFont('helvetica', 'italic');
                    doc.text(s.d, sx + 5, rowY + 18);
                   
                    // Learn More Button: Gold Background with Purple Text
                    doc.setFillColor(218, 165, 32);
                    doc.rect(sx + 68, rowY + 23, 20, 5, 'F');
                    doc.setTextColor(48, 25, 52);
                    doc.setFontSize(7);
                    doc.setFont('helvetica', 'bold');
                    doc.text('Learn More', sx + 78, rowY + 26.5, { align: 'center' });
                });
                // --- FOOTER SECTION (Page Control + Clickable Contact Cards) ---
                const totalPages = doc.internal.getNumberOfPages();
                for (let i = 1; i <= totalPages; i++) {
                    doc.setPage(i);
                   
                    if (i === totalPages) {
                        const footerY = 265;
                        const cardW = 46;
                        const cardH = 15;
                        const contacts = [
                            { label: 'EMAIL US', val: 'support@taxeasepro.com', link: 'mailto:support@taxeasepro.com' },
                            { label: 'WHATSAPP', val: '+91 98765 43210', link: 'https://wa.me/919876543210' },
                            { label: 'CALL SUPPORT', val: '+91 98765 43210', link: 'tel:+919876543210' },
                            { label: 'VISIT WEBSITE', val: 'www.taxeasepro.com', link: 'https://www.taxeasepro.com' }
                        ];
                        contacts.forEach((c, idx) => {
                            const cx = 8 + (idx * 49);
                            // Card Shadow
                            doc.setFillColor(235, 235, 235);
                            doc.rect(cx + 0.5, footerY + 0.5, cardW, cardH, 'F');
                            // Main Card Body: Dark Purple
                            doc.setFillColor(48, 25, 52);
                            doc.setDrawColor(218, 165, 32);
                            doc.setLineWidth(0.4);
                            doc.rect(cx, footerY, cardW, cardH, 'FD');
                            // Label: Silver Text
                            doc.setTextColor(220, 220, 220);
                            doc.setFontSize(7);
                            doc.setFont('helvetica', 'bold');
                            doc.text(c.label, cx + (cardW / 2), footerY + 5, { align: 'center' });
                            // Value: Bright Gold
                            doc.setTextColor(255, 215, 0);
                            doc.setFontSize(7);
                            doc.text(c.val, cx + (cardW / 2), footerY + 10, { align: 'center' });
                            // Clickable Area
                            doc.link(cx, footerY, cardW, cardH, { url: c.link });
                        });
                    }
                    // Disclaimer & Page Numbers
                    doc.setTextColor(100, 100, 100);
                    doc.setFontSize(6.5);
                    doc.setFont('helvetica', 'italic');
                    doc.text("Disclaimer: This is a system-generated report for reference. Please consult a CA for official filing.", 105, 284, { align: 'center' });
                   
                    doc.setFont('helvetica', 'normal');
                    doc.setTextColor(150, 150, 150);
                    doc.text("Page " + i + " of " + totalPages, 195, 289, { align: 'right' });
                }
                const base64 = doc.output('datauristring').split(',')[1];
                resolve(base64);
            }
        });
    }

    async function sendReport() {
        const fullName = document.getElementById('modalFullName').value.trim();
        const email = document.getElementById('modalEmail').value.trim();
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

        if (!fullName) {
            alert('Please enter your full name.');
            return;
        }
        if (!email || !emailRegex.test(email)) {
            document.getElementById('emailError').style.display = 'block';
            return;
        }
        document.getElementById('emailError').style.display = 'none';

        const sendBtn = document.getElementById('sendReportBtn');
        const loading = document.getElementById('loadingSpinner');
        sendBtn.disabled = true;
        loading.style.display = 'block';

        try {
            const pdfBase64 = await generatePDFBase64();
            const payload = {
                userName: fullName,
                email: email,
                category: window.taxData.userCategory,
                grossIncome: window.taxData.grossNormal,
                savings: window.taxData.savings,
                pdfBase64: pdfBase64
            };

            const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbytR5AreYKAO27mf7cs9tSG9dAvYaEB60UyLNveWUVgw0UDKQ8Z7j3c9RDDNUuZOYAV/exec'; // Replace with your actual Google Apps Script Web App URL

            // Is hisse ko replace karein
const response = await fetch(SCRIPT_URL, {
    method: 'POST',
    mode: 'no-cors', // <-- Ye sabse zaroori hai CORS bypass karne ke liye
    cache: 'no-cache',
    headers: {
        'Content-Type': 'text/plain' 
    },
    body: JSON.stringify(payload)
});

// Kyunki 'no-cors' mein response read nahi hota, isliye hum success maan kar chalte hain
alert('Success! Your detailed tax report has been sent to your email.');
closeModal();

          // fetch ke turant baad ye likhein
        await fetch(SCRIPT_URL, {
            method: 'POST',
            mode: 'no-cors', 
            headers: { 'Content-Type': 'text/plain' },
            body: JSON.stringify(payload)
        });

        // no-cors mode mein response.ok hamesha false hota hai, 
        // isliye hum bina check kiye success alert dikhayenge.
        alert('Success! Your detailed tax report has been sent to your email.');
        closeModal();
        } catch (error) {
            alert('Error sending report: ' + error.message + '. Please try again.');
        } finally {
            sendBtn.disabled = false;
            loading.style.display = 'none';
        }
    }

   </script>
    <div id="emailModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:1000; justify-content:center; align-items:center;">
    <div style="background:#111; padding:30px; border-radius:15px; border:1px solid #333; width:90%; max-width:400px; text-align:center;">
        <h3 style="color:#fff;">Enter Email Details</h3>
        <input type="text" id="modalName" placeholder="Full Name" style="width:100%; padding:12px; margin:10px 0; background:#222; border:1px solid #444; color:#fff; border-radius:8px;">
        <input type="email" id="modalEmail" placeholder="Email Address" style="width:100%; padding:12px; margin:10px 0; background:#222; border:1px solid #444; color:#fff; border-radius:8px;">
        <button onclick="processAndSend()" id="sendBtn" style="width:100%; padding:12px; background:#007bff; color:#fff; border:none; border-radius:8px; cursor:pointer; font-weight:bold;">Send My Report</button>
        <p onclick="document.getElementById('emailModal').style.display='none'" style="color:#888; margin-top:15px; cursor:pointer; font-size:14px;">Cancel</p>
    </div>
</div>
  
</body>
</html>
